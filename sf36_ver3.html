<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Punteggio SF-36 (Logica SPSS + Grafici Dettaglio)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; vertical-align: top;}
        th { background-color: #e9e9e9; font-weight: bold; }
        td:first-child { font-weight: bold; width: 80px; } /* ID Domanda */
        .input-col { width: 100px; text-align: center;}
        input[type="number"] {
             width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
             box-sizing: border-box;
             text-align: center;
        }
        input:invalid { border-color: red; }
        .invalid-input { border-color: red !important; background-color: #fff7f7; }
        .question-text { width: 60%; }
        .scale-info { font-size: 0.9em; color: #555; }
        #scores, .chart-container { margin-top: 30px; padding: 15px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 5px;}
        .score-table th:nth-child(2), .score-table td:nth-child(2),
        .score-table th:nth-child(3), .score-table td:nth-child(3) {
            text-align: right;
            min-width: 80px;
        }
         .score-table th:nth-child(4), .score-table td:nth-child(4) {
             text-align: right;
            min-width: 120px;
         }
        .score-display, .zscore-display, .summary-display {
             display: inline-block; text-align: right; padding: 5px; background-color: #f0f0f0; border-radius: 3px; font-family: monospace;
             min-width: 70px; /* Larghezza minima per allineamento */
        }
        .na-score { color: #888; }
        .notes { font-size: 0.9em; color: #666; margin-top: 15px; }
        .chart-container {
             position: relative; height: 40vh; width: 95%; max-width: 900px;
             margin-left: auto; margin-right: auto; margin-bottom: 30px;
        }
        .chart-container-small { /* Per grafici con meno barre */
            max-width: 500px;
            height: 35vh;
        }
        input.invalid-input {
             border-color: red;
             background-color: #ffecec;
        }
         .subheader { background-color: #f0f0f0; font-weight: bold; font-style: italic;}
    </style>
</head>
<body>

<h1>Calcolatore Punteggio SF-36 (Basato su Logica SPSS/SAS)</h1>
<p>Inserisci i valori per ciascuna domanda. Verranno calcolati: Punteggi scale 0-100, Z-scores (vs Pop. USA), Indici Sintetici ISF/ISM (T-score), secondo la logica fornita (SPSS/SAS).</p>
<p class="notes" style="color:darkgreen; font-weight:bold;">Ver4 - Logica SPSS/SAS + Grafici Dettaglio</p>

<form id="sf36-form" onsubmit="return false;">
    <table>
        <thead>
            <tr>
                <th>ID Domanda (Var SPSS/SAS)</th>
                <th class="question-text">Testo Domanda</th>
                <th class="input-col">Risposta</th>
                <th class="scale-info">Scala Valori Validi</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Q1 (GH1)</td><td class="question-text">In generale direbbe che la Sua salute è....</td><td class="input-col"><input type="number" id="q1" data-index="0" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
            <tr><td>Q2 (HT)</td><td class="question-text">Rispetto a un anno fa, come giudicherebbe, ora, la Sua salute in generale?</td><td class="input-col"><input type="number" id="q2" data-index="1" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
            <tr><td colspan="4" class="subheader"><b>Attività Fisica (PF / PF01-PF10)</b></td></tr>
            <tr><td>Q3a (PF01)</td><td>Attività fisicamente impegnative...</td><td class="input-col"><input type="number" id="q3a" data-index="2" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3b (PF02)</td><td>Attività di moderato impegno fisico...</td><td class="input-col"><input type="number" id="q3b" data-index="3" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3c (PF03)</td><td>Sollevare o portare le borse della spesa</td><td class="input-col"><input type="number" id="q3c" data-index="4" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3d (PF04)</td><td>Salire qualche piano di scale</td><td class="input-col"><input type="number" id="q3d" data-index="5" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3e (PF05)</td><td>Salire un piano di scale</td><td class="input-col"><input type="number" id="q3e" data-index="6" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3f (PF06)</td><td>Piegarsi, inginocchiarsi o chinarsi</td><td class="input-col"><input type="number" id="q3f" data-index="7" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3g (PF07)</td><td>Camminare per un chilometro</td><td class="input-col"><input type="number" id="q3g" data-index="8" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3h (PF08)</td><td>Camminare per qualche centinaia di metri</td><td class="input-col"><input type="number" id="q3h" data-index="9" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3i (PF09)</td><td>Camminare per circa cento metri</td><td class="input-col"><input type="number" id="q3i" data-index="10" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3j (PF10)</td><td>Fare il bagno o vestirsi da soli</td><td class="input-col"><input type="number" id="q3j" data-index="11" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3</td></tr>
            <tr><td colspan="4" class="subheader"><b>Limitazioni Ruolo Fisico (RP / RP1-RP4)</b></td></tr>
            <tr><td>Q4a (RP1)</td><td>Ha ridotto il tempo dedicato al lavoro o ad altre attività</td><td class="input-col"><input type="number" id="q4a" data-index="12" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q4b (RP2)</td><td>Ha reso meno di quanto avrebbe voluto</td><td class="input-col"><input type="number" id="q4b" data-index="13" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q4c (RP3)</td><td>Ha dovuto limitare alcuni tipi di lavoro o di altre attività</td><td class="input-col"><input type="number" id="q4c" data-index="14" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q4d (RP4)</td><td>Ha avuto difficoltà nell'eseguire il lavoro o altre attività...</td><td class="input-col"><input type="number" id="q4d" data-index="15" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td colspan="4" class="subheader"><b>Limitazioni Ruolo Emotivo (RE / RE1-RE3)</b></td></tr>
            <tr><td>Q5a (RE1)</td><td>Ha ridotto il tempo dedicato al lavoro o ad altre attività</td><td class="input-col"><input type="number" id="q5a" data-index="16" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q5b (RE2)</td><td>Ha reso meno di quanto avrebbe voluto</td><td class="input-col"><input type="number" id="q5b" data-index="17" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q5c (RE3)</td><td>Ha avuto un calo di concentrazione sul lavoro o in altre attività</td><td class="input-col"><input type="number" id="q5c" data-index="18" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td colspan="4" class="subheader"><b>Dolore (BP), Funz. Sociale (SF pt1), Vitalità (VT pt1), Salute Mentale (MH pt1)</b></td></tr>
            <tr><td>Q6 (SF1)</td><td class="question-text">Nelle ultime quattro settimane, in che misura la Sua salute fisica o il Suo stato emotivo hanno interferito con le normali attività sociali...</td><td class="input-col"><input type="number" id="q6" data-index="19" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
            <tr><td>Q7 (BP1)</td><td class="question-text">Quanto dolore fisico ha provato nelle ultime quattro settimane?</td><td class="input-col"><input type="number" id="q7" data-index="20" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
            <tr><td>Q8 (BP2)</td><td class="question-text">Nelle ultime quattro settimane, in che misura il dolore L'ha ostacolata nel lavoro che svolge abitualmente...?</td><td class="input-col"><input type="number" id="q8" data-index="21" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
            <tr><td>Q9a (VT1)</td><td>Vivace e brillante?</td><td class="input-col"><input type="number" id="q9a" data-index="22" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
            <tr><td>Q9b (MH1)</td><td>Molto agitato?</td><td class="input-col"><input type="number" id="q9b" data-index="23" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
            <tr><td>Q9c (MH2)</td><td>Così giù di morale che niente avrebbe potuto tirarla su?</td><td class="input-col"><input type="number" id="q9c" data-index="24" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
            <tr><td>Q9d (MH3)</td><td>Calmo e sereno?</td><td class="input-col"><input type="number" id="q9d" data-index="25" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
            <tr><td>Q9e (VT2)</td><td>Pieno di energia?</td><td class="input-col"><input type="number" id="q9e" data-index="26" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
            <tr><td>Q9f (MH4)</td><td>Scoraggiato e triste?</td><td class="input-col"><input type="number" id="q9f" data-index="27" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
            <tr><td>Q9g (VT3)</td><td>Sfinito?</td><td class="input-col"><input type="number" id="q9g" data-index="28" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
             <tr><td>Q9h (MH5)</td><td>Felice?</td><td class="input-col"><input type="number" id="q9h" data-index="29" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
             <tr><td>Q9i (VT4)</td><td>Stanco?</td><td class="input-col"><input type="number" id="q9i" data-index="30" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6</td></tr>
            <tr><td colspan="4" class="subheader"><b>Funz. Sociale (SF pt2), Salute Generale (GH pt2)</b></td></tr>
             <tr><td>Q10 (SF2)</td><td class="question-text">Nelle ultime quattro settimane, per quanto tempo la Sua salute fisica o il Suo stato emotivo hanno interferito nelle Sue attività sociali...?</td><td class="input-col"><input type="number" id="q10" data-index="31" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
             <tr><td>Q11a (GH2)</td><td>Mi pare di ammalarmi un po' più facilmente degli altri</td><td class="input-col"><input type="number" id="q11a" data-index="32" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
             <tr><td>Q11b (GH3)</td><td>La mia salute è come quella degli altri</td><td class="input-col"><input type="number" id="q11b" data-index="33" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
             <tr><td>Q11c (GH4)</td><td>Mi aspetto che la mia salute andrà peggiorando</td><td class="input-col"><input type="number" id="q11c" data-index="34" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
            <tr><td>Q11d (GH5)</td><td>Godo di ottima salute</td><td class="input-col"><input type="number" id="q11d" data-index="35" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5</td></tr>
        </tbody>
    </table>
</form>

<div id="scores">
    <h2>Punteggi Calcolati (Logica SPSS/SAS)</h2>
    <p class="notes">Punteggi 0-100: punteggio più alto indica stato migliore. Z-Score: standardizzato su Pop. Generale USA (Media=0, DS=1). ISF/ISM: indici sintetici (Media=50, DS=10). 'N/D' indica calcolo non possibile (dati mancanti).</p>
    <table class="score-table">
        <thead>
            <tr>
                <th>Dimensione SF-36</th>
                <th>Punteggio (0-100)</th>
                <th>Z-Score (Pop. USA)</th>
                <th>Componente Sintetica</th>
                <th>Punteggio T (Media 50, DS 10)</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Attività Fisica (PF)</td><td><span id="score_pf" class="score-display na-score">N/D</span></td><td><span id="zscore_pf" class="zscore-display na-score">N/D</span></td> <td rowspan="4" style="vertical-align: middle; text-align: center; border-right: 1px solid #ccc;">Indice Salute Fisica (ISF / PCS)</td> <td rowspan="4" style="vertical-align: middle; text-align: right;"><span id="summary_pcs" class="summary-display na-score">N/D</span></td> </tr>
            <tr><td>Limitazioni Ruolo Fisico (RP)</td><td><span id="score_rp" class="score-display na-score">N/D</span></td><td><span id="zscore_rp" class="zscore-display na-score">N/D</span></td></tr>
            <tr><td>Dolore Fisico (BP)</td><td><span id="score_bp" class="score-display na-score">N/D</span></td><td><span id="zscore_bp" class="zscore-display na-score">N/D</span></td></tr>
            <tr><td>Salute Generale (GH)</td><td><span id="score_gh" class="score-display na-score">N/D</span></td><td><span id="zscore_gh" class="zscore-display na-score">N/D</span></td></tr>
             <tr><td colspan="5" class="subheader"></td></tr>
            <tr><td>Vitalità (VT)</td><td><span id="score_vt" class="score-display na-score">N/D</span></td><td><span id="zscore_vt" class="zscore-display na-score">N/D</span></td> <td rowspan="4" style="vertical-align: middle; text-align: center; border-right: 1px solid #ccc;">Indice Salute Mentale (ISM / MCS)</td> <td rowspan="4" style="vertical-align: middle; text-align: right;"><span id="summary_mcs" class="summary-display na-score">N/D</span></td> </tr>
            <tr><td>Funzionamento Sociale (SF)</td><td><span id="score_sf" class="score-display na-score">N/D</span></td><td><span id="zscore_sf" class="zscore-display na-score">N/D</span></td></tr>
            <tr><td>Limitazioni Ruolo Emotivo (RE)</td><td><span id="score_re" class="score-display na-score">N/D</span></td><td><span id="zscore_re" class="zscore-display na-score">N/D</span></td></tr>
            <tr><td>Salute Mentale (MH)</td><td><span id="score_mh" class="score-display na-score">N/D</span></td><td><span id="zscore_mh" class="zscore-display na-score">N/D</span></td></tr>
            <tr><td colspan="5" class="subheader"></td></tr>
            <tr><td>Transizione Salute (HT) <br><small>(Non usata per ISF/ISM)</small></td><td><span id="score_ht" class="score-display na-score">N/D</span></td><td><span class="zscore-display" style="background-color: transparent;">-</span></td> <td></td> <td></td></tr>
        </tbody>
    </table>
     <p class="notes"><i>Nota: Il calcolo segue la logica SPSS/SAS fornita, inclusa imputazione media per missing (<50%) e formule di trasformazione. La standardizzazione (Z-score, ISF, ISM) usa norme della popolazione generale USA, non è specifica per età/sesso.</i></p>
</div>

<div class="chart-container">
    <h2>Grafico Riepilogativo Punteggi Scale (0-100)</h2>
    <canvas id="scoresChart"></canvas>
</div>

<div class="chart-container chart-container-small">
    <h2>Grafico Indici Sintetici (ISF/PCS, ISM/MCS)</h2>
    <canvas id="summaryChart"></canvas>
</div>

<div class="chart-container">
    <h2>Grafico Punteggi Z Standardizzati (vs Pop. USA)</h2>
    <canvas id="zScoreChart"></canvas>
</div>


<script>
    // --- Variabili Globali per i Grafici ---
    let scoresChartInstance = null;
    let summaryChartInstance = null;
    let zScoreChartInstance = null;
    let allAnswers = new Array(36).fill(null);

    // --- Mappatura Indici (0-based) -> Scale SF-36 ---
    const scaleItemIndices = {
        'PF': [2, 3, 4, 5, 6, 7, 8, 9, 10, 11], // Q3a-j
        'RP': [12, 13, 14, 15],                // Q4a-d
        'BP': [20, 21],                        // Q7, Q8
        'GH': [0, 32, 33, 34, 35],            // Q1, Q11a-d
        'VT': [22, 26, 28, 30],                // Q9a, Q9e, Q9g, Q9i
        'SF': [19, 31],                        // Q6, Q10
        'RE': [16, 17, 18],                    // Q5a-c
        'MH': [23, 24, 25, 27, 29],            // Q9b, Q9c, Q9d, Q9f, Q9h
        'HT': [1]                             // Q2
    };

    // --- Range Validi per Item ---
    const itemValidRanges = {
         0: {min: 1, max: 5},  1: {min: 1, max: 5},  2: {min: 1, max: 3},  3: {min: 1, max: 3},  4: {min: 1, max: 3},
         5: {min: 1, max: 3},  6: {min: 1, max: 3},  7: {min: 1, max: 3},  8: {min: 1, max: 3},  9: {min: 1, max: 3},
        10: {min: 1, max: 3}, 11: {min: 1, max: 3}, 12: {min: 1, max: 2}, 13: {min: 1, max: 2}, 14: {min: 1, max: 2},
        15: {min: 1, max: 2}, 16: {min: 1, max: 2}, 17: {min: 1, max: 2}, 18: {min: 1, max: 2}, 19: {min: 1, max: 5},
        20: {min: 1, max: 6}, 21: {min: 1, max: 5}, 22: {min: 1, max: 6}, 23: {min: 1, max: 6}, 24: {min: 1, max: 6},
        25: {min: 1, max: 6}, 26: {min: 1, max: 6}, 27: {min: 1, max: 6}, 28: {min: 1, max: 6}, 29: {min: 1, max: 6},
        30: {min: 1, max: 6}, 31: {min: 1, max: 5}, 32: {min: 1, max: 5}, 33: {min: 1, max: 5}, 34: {min: 1, max: 5},
        35: {min: 1, max: 5}
    };

     // --- Costanti per Standardizzazione Z (Pop. USA Generale - da SPSS/SAS) ---
     const usMeans = { PF: 84.52404, RP: 81.19907, BP: 75.49196, GH: 72.21316, VT: 61.05453, SF: 83.59753, RE: 81.29467, MH: 74.84212 };
     const usSDs   = { PF: 22.89490, RP: 33.79729, BP: 23.55879, GH: 20.16964, VT: 20.86942, SF: 22.37642, RE: 33.02717, MH: 18.01189 };

     // --- Pesi Fattoriali per PCS (ISF) e MCS (ISM) (Pop. USA Generale - da SPSS/SAS) ---
     // Verificati nuovamente, sembrano corretti
     const weights = {
         PCS: { PF:  0.42402, RP:  0.35119, BP:  0.31754, GH:  0.24954, VT:  0.02877, SF: -0.00753, RE: -0.19206, MH: -0.22069 },
         MCS: { PF: -0.22999, RP: -0.12329, BP: -0.09731, GH: -0.01571, VT:  0.23534, SF:  0.26876, RE:  0.43407, MH:  0.48581 }
     };

    // --- Helper Function: Ottieni e valida valore grezzo ---
    function getRawValue(inputElement) {
        if (!inputElement) return { value: null, valid: false };
        const valueStr = inputElement.value.trim();
        if (valueStr === '') {
            inputElement.classList.remove('invalid-input');
            return { value: null, valid: true }; // Missing è valido
        }
        const value = parseInt(valueStr);
        const index = parseInt(inputElement.getAttribute('data-index'));
        const range = itemValidRanges[index];
        if (isNaN(value) || !Number.isInteger(value) || !range || value < range.min || value > range.max) {
            inputElement.classList.add('invalid-input');
            return { value: null, valid: false }; // Invalido
        } else {
            inputElement.classList.remove('invalid-input');
            return { value: value, valid: true }; // Valido
        }
    }

    // --- Funzione di Calcolo Generale (Logica SPSS/SAS) ---
    function calculateSf36ScoresSPSS(answers) {
        let rawScores = {}; // Valori grezzi validati
        let results = { scores: {}, zScores: {}, summaries: {} }; // Risultati finali

        // 1. Validazione e Memorizzazione Valori Grezzi
        for (let i = 0; i < answers.length; i++) {
            const inputElement = document.querySelector(`.score-input[data-index="${i}"]`);
            rawScores[i] = inputElement ? getRawValue(inputElement).value : null;
        }

        // Funzione interna per calcolo scale 0-100
        function calculateScaleScore(scaleName, itemIndices, minValidItems, transformation) {
            let validRawValues = [];
            let missingCount = 0;
            itemIndices.forEach(index => {
                const rawValue = rawScores[index];
                if (rawValue !== null) { validRawValues.push(rawValue); }
                else { missingCount++; }
            });

            const validCount = validRawValues.length;
            if (validCount < minValidItems) { return null; } // Non calcolabile

            const rawMean = validCount > 0 ? validRawValues.reduce((a, b) => a + b, 0) / validCount : 0;

            let processedValuesSum = 0;
            itemIndices.forEach(index => {
                let valueToProcess = rawScores[index];
                if (valueToProcess === null) {
                    processedValuesSum += rawMean; // Imputa media grezza
                } else {
                    // Applica ricodifiche specifiche pre-somma (Inversione scale)
                    if (transformation.recode && transformation.recode[index]) {
                        const recodeMap = transformation.recode[index];
                        processedValuesSum += (recodeMap[valueToProcess] !== undefined ? recodeMap[valueToProcess] : valueToProcess);
                    } else {
                        processedValuesSum += valueToProcess; // Usa valore grezzo
                    }
                }
            });

            // Applica formula finale 0-100 SPSS/SAS
            // Es: PF = ((RAWPF - 10)/(30-10)) * 100 -> range = max_sum(30) - min_sum(10) = 20
            const score = ((processedValuesSum - transformation.minSum) / transformation.range) * 100;
            return score;
        }

        // 2. Calcolo Punteggi Scale 0-100 (Logica SPSS/SAS)

        // PF (10 item, min 5 validi, range 1-3)
        results.scores['PF'] = calculateScaleScore('PF', scaleItemIndices['PF'], 5, { minSum: 10, range: 20 });

        // RP (4 item, min 2 validi, range 1-2) -> Formula SAS: ((RAWRP - 4)/(8-4)) * 100
        results.scores['RP'] = calculateScaleScore('RP', scaleItemIndices['RP'], 2, { minSum: 4, range: 4 });

        // RE (3 item, min 2 validi, range 1-2) -> Formula SAS: ((RAWRE - 3)/(6-3)) * 100
        results.scores['RE'] = calculateScaleScore('RE', scaleItemIndices['RE'], 2, { minSum: 3, range: 3 });

        // VT (4 item, min 2 validi, range 1-6) -> Formula SAS: ((RAWVT-4)/(24-4)) * 100
        const vtRecodeMap = { 1: 6, 2: 5, 3: 4, 4: 3, 5: 2, 6: 1 }; // Inverti VT1, VT2
        results.scores['VT'] = calculateScaleScore('VT', scaleItemIndices['VT'], 2, {
             minSum: 4, range: 20, recode: { 22: vtRecodeMap, 26: vtRecodeMap }
         });

        // MH (5 item, min 3 validi, range 1-6) -> Formula SAS: ((RAWMH-5)/(30-5)) * 100
        const mhRecodeMap = { 1: 6, 2: 5, 3: 4, 4: 3, 5: 2, 6: 1 }; // Inverti MH3, MH5
        results.scores['MH'] = calculateScaleScore('MH', scaleItemIndices['MH'], 3, {
             minSum: 5, range: 25, recode: { 25: mhRecodeMap, 29: mhRecodeMap }
         });

        // SF (2 item, min 1 valido, range 1-5) -> Formula SAS: ((RAWSF - 2)/(10-2)) * 100
        const sfRecodeMap = { 1: 5, 2: 4, 3: 3, 4: 2, 5: 1 }; // Inverti SF1
        results.scores['SF'] = calculateScaleScore('SF', scaleItemIndices['SF'], 1, {
             minSum: 2, range: 8, recode: { 19: sfRecodeMap }
         });

        // BP (2 item, min 1 valido) - Logica Complessa SPSS/SAS
        function calculateBPScore() {
             const bp1_raw = rawScores[20]; // Q7 (1-6)
             const bp2_raw = rawScores[21]; // Q8 (1-5)
             let rbp1 = null, rbp2 = null;
             const bp1_valid = bp1_raw !== null && bp1_raw >= 1 && bp1_raw <= 6;
             const bp2_valid = bp2_raw !== null && bp2_raw >= 1 && bp2_raw <= 5;

             if (!bp1_valid && !bp2_valid) return null;

             // Ricodifica basata su SAS/SPSS
             if (bp1_valid && bp2_valid) { // Entrambi validi
                 const bp1RecMap = { 1: 6, 2: 5.4, 3: 4.2, 4: 3.1, 5: 2.2, 6: 1 };
                 rbp1 = bp1RecMap[bp1_raw];
                 if (bp1_raw === 1) { // BP1=1
                     rbp2 = 6; // Da SAS: IF BP2=1 AND BP1=1 THEN RBP2=6; (ma anche per altri BP2?) --> SPSS diceva RBP2=copy -> usiamo 6
                 } else { // BP1 >= 2
                     const bp2RecMap = { 1: 5, 2: 4, 3: 3, 4: 2, 5: 1 };
                     rbp2 = bp2RecMap[bp2_raw];
                 }
             } else if (bp1_valid && !bp2_valid) { // Solo BP1 valido
                 const bp1RecMap = { 1: 6, 2: 5.4, 3: 4.2, 4: 3.1, 5: 2.2, 6: 1 };
                 rbp1 = bp1RecMap[bp1_raw];
                 rbp2 = rbp1; // Imputazione SAS/SPSS
             } else if (!bp1_valid && bp2_valid) { // Solo BP2 valido
                 const bp2RecMapMissBp1 = { 1: 6, 2: 4.75, 3: 3.5, 4: 2.25, 5: 1 };
                 rbp2 = bp2RecMapMissBp1[bp2_raw];
                 rbp1 = rbp2; // Imputazione SAS/SPSS
             }

             if (rbp1 === null || rbp2 === null) return null;

             const rawbp = rbp1 + rbp2;
             // Formula SAS: BP = ((RAWBP - 2)/(12-2)) * 100;
             const bp_score = ((rawbp - 2) / 10) * 100;
             return bp_score;
         }
        results.scores['BP'] = calculateBPScore();

        // GH (5 item, min 3 validi, range 1-5) -> Formula SAS: ((RAWGH - 5)/(25-5)) * 100
        const gh1RecodeMap = { 1: 5, 2: 4.4, 3: 3.4, 4: 2, 5: 1 }; // Recode speciale GH1
        const ghStdRecodeMap = { 1: 5, 2: 4, 3: 3, 4: 2, 5: 1 }; // Inverti GH3, GH5
        results.scores['GH'] = calculateScaleScore('GH', scaleItemIndices['GH'], 3, {
             minSum: 5, range: 20,
             recode: { 0: gh1RecodeMap, 33: ghStdRecodeMap, 35: ghStdRecodeMap }
         });

         // HT (1 item)
         const htRaw = rawScores[1]; // Q2
         if (htRaw !== null && htRaw >= 1 && htRaw <= 5) {
            const htRecodeMap = { 1: 100, 2: 75, 3: 50, 4: 25, 5: 0 }; // Scala invertita 0-100
            results.scores['HT'] = htRecodeMap[htRaw];
         } else {
            results.scores['HT'] = null;
         }

        // 3. Calcolo Z-Scores
        let allScoresValidForSummaries = true;
        for (const scale in usMeans) {
            const score = results.scores[scale];
            if (score !== null && !isNaN(score)) {
                results.zScores[scale] = (score - usMeans[scale]) / usSDs[scale];
            } else {
                results.zScores[scale] = null;
                allScoresValidForSummaries = false; // Se manca uno, non calcoliamo ISF/ISM
            }
        }

        // 4. Calcolo Indici Sintetici (ISF/PCS, ISM/MCS)
        results.summaries['PCS'] = null;
        results.summaries['MCS'] = null;
        if (allScoresValidForSummaries) {
            try {
                let praw = 0;
                let mraw = 0;
                for (const scale in weights.PCS) {
                    // Verifica che lo Z-score esista (dovrebbe se allScoresValidForSummaries è true)
                    if (results.zScores[scale] !== null && weights.PCS[scale] !== undefined) {
                         praw += results.zScores[scale] * weights.PCS[scale];
                    } else { throw new Error(`Missing Z-score or weight for PCS: ${scale}`); } // Sicurezza

                    if (results.zScores[scale] !== null && weights.MCS[scale] !== undefined) {
                         mraw += results.zScores[scale] * weights.MCS[scale];
                    } else { throw new Error(`Missing Z-score or weight for MCS: ${scale}`); } // Sicurezza
                }
                // Trasforma in T-score
                results.summaries['PCS'] = (praw * 10) + 50; // ISF
                results.summaries['MCS'] = (mraw * 10) + 50; // ISM
            } catch (error) {
                console.error("Errore nel calcolo degli indici sintetici:", error);
                // Lascia PCS e MCS a null se c'è stato un problema imprevisto
            }
        }

        return results;
    }


    // --- Funzioni di Inizializzazione Grafici ---
    function initScoresChart() { // Grafico scale 0-100
        const ctx = document.getElementById('scoresChart').getContext('2d');
        const chartLabels = ['PF', 'RP', 'BP', 'GH', 'VT', 'SF', 'RE', 'MH', 'HT'];
        const chartDisplayLabels = [ 'Att. Fisica', 'R. Fisico', 'Dolore', 'Salute Gen.', 'Vitalità', 'Funz. Sociale', 'R. Emotivo', 'Salute Mentale', 'Trans. Salute' ];
        const backgroundColors = ['#4BC0C0', '#FF6384', '#FFCE56', '#36A2EB', '#9966FF', '#FF9F40', '#C9CBCF', '#4D5360', '#AABBCC'];

        scoresChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartDisplayLabels,
                datasets: [{
                    label: 'Punteggi SF-36 (0-100)', data: Array(chartLabels.length).fill(0),
                    backgroundColor: backgroundColors, borderColor: backgroundColors, borderWidth: 1,
                    originalScores: Array(chartLabels.length).fill('N/D'), scaleKeys: chartLabels
                }]
            },
            options: { // Opzioni simili a prima
                responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Punteggio (0-100)' } }, x: {} },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: tooltipCallback } } }
            }
        });
    }

    function initSummaryChart() { // Grafico ISF/ISM
        const ctx = document.getElementById('summaryChart').getContext('2d');
        const chartLabels = ['PCS', 'MCS'];
        const chartDisplayLabels = ['ISF / PCS', 'ISM / MCS'];
        const backgroundColors = ['#E67E22', '#3498DB']; // Colori distinti

        summaryChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartDisplayLabels,
                datasets: [{
                    label: 'Indici Sintetici (T-Score)', data: [0, 0], // Inizializza a 0
                    backgroundColor: backgroundColors, borderColor: backgroundColors, borderWidth: 1,
                    originalScores: ['N/D', 'N/D'], scaleKeys: chartLabels
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                scales: {
                    y: { beginAtZero: false, min: 0, max: 100, title: { display: true, text: 'Punteggio T (Media 50, DS 10)' } }, // Scala 0-100 per T-score
                    x: {}
                },
                 plugins: { legend: { display: false }, tooltip: { callbacks: { label: tooltipCallback } } }
            }
        });
    }

     function initZScoreChart() { // Grafico Z-Scores
        const ctx = document.getElementById('zScoreChart').getContext('2d');
        const chartLabels = ['PF', 'RP', 'BP', 'GH', 'VT', 'SF', 'RE', 'MH']; // Solo le 8 scale
        const chartDisplayLabels = [ 'Att. Fisica', 'R. Fisico', 'Dolore', 'Salute Gen.', 'Vitalità', 'Funz. Sociale', 'R. Emotivo', 'Salute Mentale' ];
        const backgroundColors = ['#4BC0C0', '#FF6384', '#FFCE56', '#36A2EB', '#9966FF', '#FF9F40', '#C9CBCF', '#4D5360'];

        zScoreChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartDisplayLabels,
                datasets: [{
                    label: 'Punteggio Z (vs Pop. USA)', data: Array(chartLabels.length).fill(0),
                    backgroundColor: backgroundColors, borderColor: backgroundColors, borderWidth: 1,
                    originalScores: Array(chartLabels.length).fill('N/D'), scaleKeys: chartLabels
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                scales: {
                     // Scala Y centrata su 0 per Z-scores
                    y: { beginAtZero: false, suggestedMin: -3, suggestedMax: 3, title: { display: true, text: 'Punteggio Z (Media 0, DS 1)' } },
                    x: {}
                },
                 plugins: { legend: { display: false }, tooltip: { callbacks: { label: tooltipCallback } } }
            }
        });
    }

    // --- Callback per Tooltip ---
    function tooltipCallback(context) {
        let label = context.dataset.label || '';
        if (label) { label += ': '; }
        const originalScore = context.chart.data.datasets[context.datasetIndex].originalScores[context.dataIndex];
        label += originalScore;
        return label;
    }


    // --- Funzione Principale & Aggiornamento UI ---
    function updateScoresAndChart() {
        // Leggi input grezzi
        allAnswers = [];
        document.querySelectorAll('.score-input').forEach(input => {
            allAnswers[parseInt(input.getAttribute('data-index'))] = getRawValue(input).value;
        });

        // Calcola punteggi
        const results = calculateSf36ScoresSPSS(allAnswers);

        // Aggiorna tabella HTML
        Object.keys(results.scores).forEach(scale => {
             updateDisplay(`score_${scale.toLowerCase()}`, results.scores[scale], 'na-score'); });
        Object.keys(results.zScores).forEach(scale => {
             updateDisplay(`zscore_${scale.toLowerCase()}`, results.zScores[scale], 'na-score'); });
        Object.keys(results.summaries).forEach(summary => {
             updateDisplay(`summary_${summary.toLowerCase()}`, results.summaries[summary], 'na-score'); });

        // Aggiorna Grafico Punteggi 0-100
        updateChartData(scoresChartInstance, results.scores);
        // Aggiorna Grafico Indici Sintetici
        updateChartData(summaryChartInstance, results.summaries);
        // Aggiorna Grafico Z-Scores
        updateChartData(zScoreChartInstance, results.zScores);
    }

    // Helper per aggiornare span nella tabella
    function updateDisplay(elementId, value, naClass) {
        const element = document.getElementById(elementId);
        if (!element) return;
        const displayValue = (value === null || isNaN(value)) ? 'N/D' : value.toFixed(2);
        element.textContent = displayValue;
        if (displayValue === 'N/D') { element.classList.add(naClass); }
        else { element.classList.remove(naClass); }
    }

    // Helper per aggiornare i dati di un grafico
    function updateChartData(chartInstance, dataObject) {
        if (!chartInstance || !dataObject) return;
        const chartKeys = chartInstance.data.datasets[0].scaleKeys;
        const chartData = [];
        const tooltipData = [];
        chartKeys.forEach(key => {
            const value = dataObject[key];
            chartData.push((value === null || isNaN(value)) ? 0 : value);
            tooltipData.push((value === null || isNaN(value)) ? 'N/D' : value.toFixed(2));
        });
        chartInstance.data.datasets[0].data = chartData;
        chartInstance.data.datasets[0].originalScores = tooltipData;
        chartInstance.update();
    }


    // --- Event Listener ---
    document.addEventListener('DOMContentLoaded', () => {
        // Inizializza tutti i grafici
        initScoresChart();
        initSummaryChart();
        initZScoreChart();

        // Aggiungi listener agli input
        document.querySelectorAll('.score-input').forEach(input => {
            if (!input.hasAttribute('data-index')) { console.warn("Input senza data-index:", input.id); }
            input.addEventListener('input', updateScoresAndChart);
            input.addEventListener('blur', updateScoresAndChart);
        });

        // Calcola all'inizio
        updateScoresAndChart();
    });

</script>

</body>
</html>
