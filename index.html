<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Punteggio SF-36. Codice elaborato partendo dal sito dell'Istituto Mario Negri)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@^3"></script>

    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1, h2 { color: #333; }
        h3 { margin-top: 30px; color: #555; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; vertical-align: top;}
        th { background-color: #e9e9e9; font-weight: bold; }
        td:first-child { font-weight: bold; min-width: 80px; }
        .input-col { width: 100px; text-align: center;}
        .input-col-small { width: 120px; text-align: center; }
        input[type="number"], select {
            width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
            box-sizing: border-box;
            text-align: center;
        }
        input:invalid, select:invalid { border-color: red; }
        .invalid-input { border-color: red !important; background-color: #fff7f7; }
        .question-text { width: 60%; }
        .scale-info { font-size: 0.9em; color: #555; }
        #scores, .chart-container { margin-top: 30px; padding: 15px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 5px;}
        .score-table th:nth-child(n+2), .score-table td:nth-child(n+2) { /* Allinea a destra dalla seconda colonna */
            text-align: right;
            min-width: 80px;
        }
        .score-display, .zscore-display, .summary-display, .agesex-tscore-display {
            display: inline-block; text-align: right; padding: 5px; background-color: #f0f0f0; border-radius: 3px; font-family: monospace;
            min-width: 70px;
        }
        .na-score { color: #888; }
        .notes { font-size: 0.9em; color: #666; margin-top: 15px; }
        .warning { color: #c0392b; font-weight: bold;}
        .chart-container {
            position: relative; height: 40vh; width: 95%; max-width: 900px;
            margin-left: auto; margin-right: auto; margin-bottom: 30px;
        }
        .chart-container-small { max-width: 500px; height: 35vh; }
        input.invalid-input { border-color: red; background-color: #ffecec; }
         .subheader { background-color: #f0f0f0; font-weight: bold; font-style: italic;}
         .hidden-section { display: none; } /* Per nascondere sezioni */
         .scale-info ul { margin: 0; padding-left: 15px; font-size: 0.9em; } /* Stile per la lista */
    </style>
</head>
<body>

<h1>Calcolatore Punteggio SF-36</h1>
<p>Inserisci i valori per ciascuna domanda, l'età e il sesso. Verranno calcolati: Punteggi scale 0-100, Z-scores (vs Pop. USA), Indici Sintetici ISF/ISM (T-score USA), e Punteggi T standardizzati per Età e Sesso (vs Pop. Italiana, basati su punteggi 0-100 calcolati).</p>
<p class="notes warning">Se Età o Sesso non vengono inseriti, i punteggi standardizzati per età/sesso e il relativo grafico non saranno calcolati.</p>
<p class="notes" style="color:purple; font-weight:bold;">Ver8 - Scoring 0-100 allineato a logica Mario Negri, grafici Z-score e T-score ITA rimossi</p>

<form id="sf36-form" onsubmit="return false;">
    <h3>Dati Demografici</h3>
     <table>
         <thead>
            <tr><th>Parametro</th><th class="input-col-small">Valore</th><th>Note</th></tr>
         </thead>
         <tbody>
            <tr>
                <td>Età</td>
                <td class="input-col-small"><input type="number" id="eta" class="demographic-input" min="1" max="120" step="1"></td>
                <td>Inserire l'età in anni. Necessaria per la standardizzazione specifica.</td>
            </tr>
            <tr>
                <td>Sesso</td>
                 <td class="input-col-small">
                     <select id="sesso" class="demographic-input">
                        <option value="" selected>-- Seleziona --</option>
                        <option value="1">Maschio</option>
                        <option value="2">Femmina</option>
                    </select>
                 </td>
                 <td>Selezionare il sesso biologico. Necessario per la standardizzazione specifica.</td>
            </tr>
         </tbody>
     </table>

     <h3>Risposte Questionario SF-36</h3>
     <table>
        <thead>
            <tr>
                <th>ID Domanda (Var SPSS/SAS)</th>
                <th class="question-text">Testo Domanda</th>
                <th class="input-col">Risposta</th>
                <th class="scale-info">Scala Valori Validi</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Q1 (GH1)</td><td class="question-text">In generale, direbbe che la Sua salute è:</td><td class="input-col"><input type="number" id="q1" data-index="0" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Eccellente</li><li>2: Molto buona</li><li>3: Buona</li><li>4: Passabile</li><li>5: Scadente</li></ul></td></tr>
            <tr><td>Q2 (HT)</td><td class="question-text">Rispetto ad un anno fa, come giudicherebbe, ora, la Sua salute in generale?</td><td class="input-col"><input type="number" id="q2" data-index="1" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Decisamente migliore</li><li>2: Un po' migliore</li><li>3: Più o meno uguale</li><li>4: Un po' peggiore</li><li>5: Decisamente peggiore</li></ul></td></tr>
            <tr><td colspan="4" class="subheader"><b>3. La Sua salute La limita attualmente nello svolgimento di queste attività?</b></td></tr>
            <tr><td>Q3a (PF01)</td><td>Attività fisicamente impegnative, come correre, sollevare oggetti pesanti, praticare sport faticosi</td><td class="input-col"><input type="number" id="q3a" data-index="2" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3b (PF02)</td><td>Attività di moderato impegno fisico, come spostare un tavolo, usare l'aspirapolvere, giocare a bocce o fare un giretto in bicicletta</td><td class="input-col"><input type="number" id="q3b" data-index="3" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3c (PF03)</td><td>Sollevare o portare le borse della spesa</td><td class="input-col"><input type="number" id="q3c" data-index="4" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3d (PF04)</td><td>Salire qualche piano di scale</td><td class="input-col"><input type="number" id="q3d" data-index="5" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3e (PF05)</td><td>Salire un piano di scale</td><td class="input-col"><input type="number" id="q3e" data-index="6" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3f (PF06)</td><td>Piegarsi, inginocchiarsi o chinarsi</td><td class="input-col"><input type="number" id="q3f" data-index="7" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3g (PF07)</td><td>Camminare per un chilometro</td><td class="input-col"><input type="number" id="q3g" data-index="8" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3h (PF08)</td><td>Camminare per qualche centinaia di metri</td><td class="input-col"><input type="number" id="q3h" data-index="9" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3i (PF09)</td><td>Camminare per circa cento metri</td><td class="input-col"><input type="number" id="q3i" data-index="10" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td>Q3j (PF10)</td><td>Fare il bagno o vestirsi da soli</td><td class="input-col"><input type="number" id="q3j" data-index="11" class="score-input" min="1" max="3" step="1"></td>
                <td class="scale-info">1-3 <ul><li>1: Sì, limita parecchio</li><li>2: Sì, limita parzialmente</li><li>3: No, non limita per nulla</li></ul></td></tr>
            <tr><td colspan="4" class="subheader"><b>4. Nelle ultime 4 settimane, ha riscontrato i seguenti problemi sul lavoro o nelle altre attività quotidiane, a causa della Sua salute fisica?</b></td></tr>
            <tr><td>Q4a (RP1)</td><td>Ha ridotto il tempo dedicato al lavoro o ad altre attività</td><td class="input-col"><input type="number" id="q4a" data-index="12" class="score-input" min="1" max="2" step="1"></td>
                <td class="scale-info">1-2 <ul><li>1: Sì</li><li>2: No</li></ul></td></tr>
            <tr><td>Q4b (RP2)</td><td>Ha reso meno di quanto avrebbe voluto</td><td class="input-col"><input type="number" id="q4b" data-index="13" class="score-input" min="1" max="2" step="1"></td>
                <td class="scale-info">1-2 <ul><li>1: Sì</li><li>2: No</li></ul></td></tr>
            <tr><td>Q4c (RP3)</td><td>Ha dovuto limitare alcuni tipi di lavoro o di altre attività</td><td class="input-col"><input type="number" id="q4c" data-index="14" class="score-input" min="1" max="2" step="1"></td>
                <td class="scale-info">1-2 <ul><li>1: Sì</li><li>2: No</li></ul></td></tr>
            <tr><td>Q4d (RP4)</td><td>Ha avuto difficoltà nell'eseguire il lavoro o altre attività (ad esempio, ha fatto più fatica)</td><td class="input-col"><input type="number" id="q4d" data-index="15" class="score-input" min="1" max="2" step="1"></td>
                <td class="scale-info">1-2 <ul><li>1: Sì</li><li>2: No</li></ul></td></tr>
            <tr><td colspan="4" class="subheader"><b>5. Nelle ultime 4 settimane, ha riscontrato i seguenti problemi sul lavoro o nelle altre attività, a causa del Suo stato emotivo (quale il sentirsi depresso o ansioso)?</b></td></tr>
            <tr><td>Q5a (RE1)</td><td>Ha ridotto il tempo dedicato al lavoro o ad altre attività</td><td class="input-col"><input type="number" id="q5a" data-index="16" class="score-input" min="1" max="2" step="1"></td>
                <td class="scale-info">1-2 <ul><li>1: Sì</li><li>2: No</li></ul></td></tr>
            <tr><td>Q5b (RE2)</td><td>Ha reso meno di quanto avrebbe voluto</td><td class="input-col"><input type="number" id="q5b" data-index="17" class="score-input" min="1" max="2" step="1"></td>
                <td class="scale-info">1-2 <ul><li>1: Sì</li><li>2: No</li></ul></td></tr>
            <tr><td>Q5c (RE3)</td><td>Ha avuto un calo di concentrazione sul lavoro o in altre attività</td><td class="input-col"><input type="number" id="q5c" data-index="18" class="score-input" min="1" max="2" step="1"></td>
                <td class="scale-info">1-2 <ul><li>1: Sì</li><li>2: No</li></ul></td></tr>
            <tr><td colspan="4" class="subheader"><b>Altre Domande (ultime 4 settimane)</b></td></tr>
            <tr><td>Q6 (SF1)</td><td class="question-text">Nelle ultime 4 settimane, in che misura la Sua salute fisica o il Suo stato emotivo hanno interferito con le normali attività sociali con la famiglia, gli amici, i vicini di casa, i gruppi di cui fa parte?</td><td class="input-col"><input type="number" id="q6" data-index="19" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Per nulla</li><li>2: Leggermente</li><li>3: Un po'</li><li>4: Molto</li><li>5: Moltissimo</li></ul></td></tr>
            <tr><td>Q7 (BP1)</td><td class="question-text">Quanto dolore fisico ha provato nelle ultime 4 settimane?</td><td class="input-col"><input type="number" id="q7" data-index="20" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Nessuno</li><li>2: Molto lieve</li><li>3: Lieve</li><li>4: Moderato</li><li>5: Forte</li><li>6: Molto forte</li></ul></td></tr>
            <tr><td>Q8 (BP2)</td><td class="question-text">Nelle ultime 4 settimane, in che misura il dolore L'ha ostacolata nel lavoro che svolge abitualmente (sia in casa sia fuori casa)?</td><td class="input-col"><input type="number" id="q8" data-index="21" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Per nulla</li><li>2: Molto poco</li><li>3: Un po'</li><li>4: Molto</li><li>5: Moltissimo</li></ul></td></tr>
            <tr><td colspan="4" class="subheader"><b>9. Per quanto tempo nelle ultime 4 settimane si è sentito...</b></td></tr>
            <tr><td>Q9a (VT1)</td><td>Vivace e brillante?</td><td class="input-col"><input type="number" id="q9a" data-index="22" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
            <tr><td>Q9b (MH1)</td><td>Molto agitato?</td><td class="input-col"><input type="number" id="q9b" data-index="23" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
            <tr><td>Q9c (MH2)</td><td>Così giù di morale che niente avrebbe potuto tirarLa su?</td><td class="input-col"><input type="number" id="q9c" data-index="24" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
            <tr><td>Q9d (MH3)</td><td>Calmo e sereno?</td><td class="input-col"><input type="number" id="q9d" data-index="25" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
            <tr><td>Q9e (VT2)</td><td>Pieno di energia?</td><td class="input-col"><input type="number" id="q9e" data-index="26" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
            <tr><td>Q9f (MH4)</td><td>Scoraggiato e triste?</td><td class="input-col"><input type="number" id="q9f" data-index="27" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
            <tr><td>Q9g (VT3)</td><td>Sfinito?</td><td class="input-col"><input type="number" id="q9g" data-index="28" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
             <tr><td>Q9h (MH5)</td><td>Felice?</td><td class="input-col"><input type="number" id="q9h" data-index="29" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
             <tr><td>Q9i (VT4)</td><td>Stanco?</td><td class="input-col"><input type="number" id="q9i" data-index="30" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Molto tempo</li><li>4: Una parte del tempo</li><li>5: Quasi mai</li><li>6: Mai</li></ul></td></tr>
            <tr><td colspan="4" class="subheader"><b>Altre Domande (ultime 4 settimane / affermazioni)</b></td></tr>
             <tr><td>Q10 (SF2)</td><td class="question-text">Nelle ultime 4 settimane, per quanto tempo la Sua salute fisica o il Suo stato emotivo hanno interferito nelle Sue attività sociali, in famiglia, con gli amici?</td><td class="input-col"><input type="number" id="q10" data-index="31" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Sempre</li><li>2: Quasi sempre</li><li>3: Una parte del tempo</li><li>4: Quasi mai</li><li>5: Mai</li></ul></td></tr>
             <tr><td colspan="4" class="subheader"><b>11. Scelga la risposta che meglio descrive quanto siano VERE o FALSE le seguenti affermazioni</b></td></tr>
             <tr><td>Q11a (GH2)</td><td>Mi pare di ammalarmi un po' più facilmente degli altri</td><td class="input-col"><input type="number" id="q11a" data-index="32" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Certamente vero</li><li>2: In gran parte vero</li><li>3: Non so</li><li>4: In gran parte falso</li><li>5: Certamente falso</li></ul></td></tr>
             <tr><td>Q11b (GH3)</td><td>La mia salute è come quella degli altri</td><td class="input-col"><input type="number" id="q11b" data-index="33" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Certamente vero</li><li>2: In gran parte vero</li><li>3: Non so</li><li>4: In gran parte falso</li><li>5: Certamente falso</li></ul></td></tr>
             <tr><td>Q11c (GH4)</td><td>Mi aspetto che la mia salute andrà peggiorando</td><td class="input-col"><input type="number" id="q11c" data-index="34" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Certamente vero</li><li>2: In gran parte vero</li><li>3: Non so</li><li>4: In gran parte falso</li><li>5: Certamente falso</li></ul></td></tr>
            <tr><td>Q11d (GH5)</td><td>Godo di ottima salute</td><td class="input-col"><input type="number" id="q11d" data-index="35" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 <ul><li>1: Certamente vero</li><li>2: In gran parte vero</li><li>3: Non so</li><li>4: In gran parte falso</li><li>5: Certamente falso</li></ul></td></tr>
        </tbody>
    </table>
</form>

<div id="scores">
    <h2>Punteggi Calcolati</h2>

    <h3>Punteggi Scale 0-100 e Standardizzazione USA</h3>
     <p class="notes">Punteggi 0-100: punteggio più alto indica stato migliore. Z-Score USA: standardizzato su Pop. Generale USA (Media=0, DS=1). ISF/ISM: indici sintetici USA (Media=50, DS=10). 'N/D' indica calcolo non possibile (dati mancanti).</p>
     <table class="score-table">
         <thead>
             <tr>
                 <th>Dimensione SF-36</th>
                 <th>Punteggio (0-100)</th>
                 <th>Z-Score (Pop. USA)</th>
                 <th>Componente Sintetica (USA)</th>
                 <th>Punteggio T (USA)</th>
             </tr>
         </thead>
         <tbody>
             <tr><td>Attività Fisica (PF)</td><td><span id="score_pf" class="score-display na-score">N/D</span></td><td><span id="zscore_pf" class="zscore-display na-score">N/D</span></td> <td rowspan="4" style="vertical-align: middle; text-align: center; border-right: 1px solid #ccc;">Indice Salute Fisica (ISF / PCS)</td> <td rowspan="4" style="vertical-align: middle; text-align: right;"><span id="summary_pcs" class="summary-display na-score">N/D</span></td> </tr>
             <tr><td>Limitazioni Ruolo Fisico (RP)</td><td><span id="score_rp" class="score-display na-score">N/D</span></td><td><span id="zscore_rp" class="zscore-display na-score">N/D</span></td></tr>
             <tr><td>Dolore Fisico (BP)</td><td><span id="score_bp" class="score-display na-score">N/D</span></td><td><span id="zscore_bp" class="zscore-display na-score">N/D</span></td></tr>
             <tr><td>Salute Generale (GH)</td><td><span id="score_gh" class="score-display na-score">N/D</span></td><td><span id="zscore_gh" class="zscore-display na-score">N/D</span></td></tr>
             <tr><td colspan="5" class="subheader"></td></tr>
             <tr><td>Vitalità (VT)</td><td><span id="score_vt" class="score-display na-score">N/D</span></td><td><span id="zscore_vt" class="zscore-display na-score">N/D</span></td> <td rowspan="4" style="vertical-align: middle; text-align: center; border-right: 1px solid #ccc;">Indice Salute Mentale (ISM / MCS)</td> <td rowspan="4" style="vertical-align: middle; text-align: right;"><span id="summary_mcs" class="summary-display na-score">N/D</span></td> </tr>
             <tr><td>Funzionamento Sociale (SF)</td><td><span id="score_sf" class="score-display na-score">N/D</span></td><td><span id="zscore_sf" class="zscore-display na-score">N/D</span></td></tr>
             <tr><td>Limitazioni Ruolo Emotivo (RE)</td><td><span id="score_re" class="score-display na-score">N/D</span></td><td><span id="zscore_re" class="zscore-display na-score">N/D</span></td></tr>
             <tr><td>Salute Mentale (MH)</td><td><span id="score_mh" class="score-display na-score">N/D</span></td><td><span id="zscore_mh" class="zscore-display na-score">N/D</span></td></tr>
             <tr><td colspan="5" class="subheader"></td></tr>
             <tr><td>Transizione Salute (HT) <br><small>(Non usata per ISF/ISM)</small></td><td><span id="score_ht" class="score-display na-score">N/D</span></td><td><span class="zscore-display" style="background-color: transparent;">-</span></td> <td></td> <td></td></tr>
         </tbody>
     </table>

     <div id="age-sex-scores-section" class="hidden-section"> <h3>Punteggi T Standardizzati per Età e Sesso (Pop. Italiana)</h3>
         <p class="notes">Confronta il punteggio 0-100 con la media della popolazione italiana di riferimento per età e sesso specifici. Punteggio T: Media=50, DS=10. Valori > 50 indicano salute migliore della media del gruppo di riferimento.</p>
         <p id="age-sex-warning" class="notes warning">Inserire Età e Sesso validi per calcolare questi punteggi.</p>
         <table class="score-table">
              <thead>
                 <tr>
                     <th>Dimensione SF-36</th>
                     <th>Punteggio T (Età/Sesso ITA)</th>
                 </tr>
             </thead>
             <tbody>
                <tr><td>Attività Fisica (PF)</td><td><span id="agesex_pf" class="agesex-tscore-display na-score">N/D</span></td></tr>
                <tr><td>Limitazioni Ruolo Fisico (RP)</td><td><span id="agesex_rp" class="agesex-tscore-display na-score">N/D</span></td></tr>
                <tr><td>Dolore Fisico (BP)</td><td><span id="agesex_bp" class="agesex-tscore-display na-score">N/D</span></td></tr>
                <tr><td>Salute Generale (GH)</td><td><span id="agesex_gh" class="agesex-tscore-display na-score">N/D</span></td></tr>
                <tr><td>Vitalità (VT)</td><td><span id="agesex_vt" class="agesex-tscore-display na-score">N/D</span></td></tr>
                <tr><td>Funzionamento Sociale (SF)</td><td><span id="agesex_sf" class="agesex-tscore-display na-score">N/D</span></td></tr>
                <tr><td>Limitazioni Ruolo Emotivo (RE)</td><td><span id="agesex_re" class="agesex-tscore-display na-score">N/D</span></td></tr>
                <tr><td>Salute Mentale (MH)</td><td><span id="agesex_mh" class="agesex-tscore-display na-score">N/D</span></td></tr>
             </tbody>
         </table>
     </div>

     <p class="notes"><i>Nota: Il calcolo delle scale 0-100 segue la logica dell'Istituto Mario Negri (come da script di riferimento). La standardizzazione USA (Z-score, ISF, ISM) usa norme generali USA. La standardizzazione Età/Sesso usa norme specifiche italiane (come da codice fornito).</i></p>
</div>

<h3>Grafici Riepilogativi</h3>

<div class="chart-container">
    <h2>Grafico Punteggi Scale (0-100)</h2>
    <canvas id="scoresChart"></canvas>
</div>

<div class="chart-container chart-container-small">
    <h2>Grafico Indici Sintetici USA (ISF/PCS, ISM/MCS)</h2>
    <canvas id="summaryChart"></canvas>
</div>

<script>
    // --- Variabili Globali Grafici ---
    let scoresChartInstance = null;
    let summaryChartInstance = null;
    // let zScoreChartInstance = null; // RIMOSSO
    // let ageSexTScoreChartInstance = null; // RIMOSSO
    let allAnswers = new Array(36).fill(null);
    let demographicData = { age: null, sex: null, ageClass: 0, canCalculateAgeSex: false };

    const itemValidRanges = { 0: {min: 1, max: 5},  1: {min: 1, max: 5},  2: {min: 1, max: 3},  3: {min: 1, max: 3},  4: {min: 1, max: 3}, 5: {min: 1, max: 3},  6: {min: 1, max: 3},  7: {min: 1, max: 3},  8: {min: 1, max: 3},  9: {min: 1, max: 3}, 10: {min: 1, max: 3}, 11: {min: 1, max: 3}, 12: {min: 1, max: 2}, 13: {min: 1, max: 2}, 14: {min: 1, max: 2}, 15: {min: 1, max: 2}, 16: {min: 1, max: 2}, 17: {min: 1, max: 2}, 18: {min: 1, max: 2}, 19: {min: 1, max: 5}, 20: {min: 1, max: 6}, 21: {min: 1, max: 5}, 22: {min: 1, max: 6}, 23: {min: 1, max: 6}, 24: {min: 1, max: 6}, 25: {min: 1, max: 6}, 26: {min: 1, max: 6}, 27: {min: 1, max: 6}, 28: {min: 1, max: 6}, 29: {min: 1, max: 6}, 30: {min: 1, max: 6}, 31: {min: 1, max: 5}, 32: {min: 1, max: 5}, 33: {min: 1, max: 5}, 34: {min: 1, max: 5}, 35: {min: 1, max: 5} };
    const usMeans = { PF: 84.52404, RP: 81.19907, BP: 75.49196, GH: 72.21316, VT: 61.05453, SF: 83.59753, RE: 81.29467, MH: 74.84212 };
    const usSDs   = { PF: 22.89490, RP: 33.79729, BP: 23.55879, GH: 20.16964, VT: 20.86942, SF: 22.37642, RE: 33.02717, MH: 18.01189 };
    const weights = { PCS: { PF:  0.42402, RP:  0.35119, BP:  0.31754, GH:  0.24954, VT:  0.02877, SF: -0.00753, RE: -0.19206, MH: -0.22069 }, MCS: { PF: -0.22999, RP: -0.12329, BP: -0.09731, GH: -0.01571, VT:  0.23534, SF:  0.26876, RE:  0.43407, MH:  0.48581 } };

    const ageSexNorms = {
        1: { // Sesso = 1 (Maschio)
            2: { PF: { mean: 96.4851, sd: 7.9544 }, RP: { mean: 91.0891, sd: 19.8696 }, BP: { mean: 90.9505, sd: 14.0124 }, GH: { mean: 81.2079, sd: 13.1972 }, VT: { mean: 73.1683, sd: 15.3252 }, SF: { mean: 85.5198, sd: 17.9176 }, RE: { mean: 84.8185, sd: 28.8770 }, MH: { mean: 76.1980, sd: 12.7421 } },
            3: { PF: { mean: 95.9172, sd: 10.3604 }, RP: { mean: 90.2367, sd: 24.7175 }, BP: { mean: 83.0888, sd: 23.1593 }, GH: { mean: 76.9053, sd: 15.6849 }, VT: { mean: 70.3748, sd: 15.2110 }, SF: { mean: 84.8373, sd: 17.6337 }, RE: { mean: 89.7436, sd: 23.8492 }, MH: { mean: 75.3609, sd: 14.1781 } },
            4: { PF: { mean: 95.6915, sd: 8.0141 }, RP: { mean: 90.5585, sd: 24.8112 }, BP: { mean: 81.6064, sd: 22.8118 }, GH: { mean: 71.5479, sd: 18.1271 }, VT: { mean: 67.5709, sd: 16.9480 }, SF: { mean: 82.9122, sd: 19.4269 }, RE: { mean: 83.6007, sd: 31.3703 }, MH: { mean: 73.6330, sd: 17.3180 } },
            5: { PF: { mean: 91.2641, sd: 14.0467 }, RP: { mean: 88.0240, sd: 25.7183 }, BP: { mean: 81.5621, sd: 21.8490 }, GH: { mean: 68.3905, sd: 17.8583 }, VT: { mean: 67.1687, sd: 18.4587 }, SF: { mean: 80.1775, sd: 21.7579 }, RE: { mean: 81.2121, sd: 34.1943 }, MH: { mean: 70.7892, sd: 17.9112 } },
            6: { PF: { mean: 83.2193, sd: 23.8917 }, RP: { mean: 73.0263, sd: 38.9943 }, BP: { mean: 73.9105, sd: 27.9990 }, GH: { mean: 61.1789, sd: 22.7691 }, VT: { mean: 64.1534, sd: 22.1833 }, SF: { mean: 79.2763, sd: 25.2756 }, RE: { mean: 73.5088, sd: 39.3207 }, MH: { mean: 69.2751, sd: 21.5863 } },
            7: { PF: { mean: 72.4609, sd: 26.4575 }, RP: { mean: 65.1575, sd: 43.6615 }, BP: { mean: 68.2656, sd: 29.3691 }, GH: { mean: 55.4141, sd: 21.5152 }, VT: { mean: 59.5703, sd: 21.5723 }, SF: { mean: 76.0742, sd: 25.2949 }, RE: { mean: 72.2222, sd: 38.8158 }, MH: { mean: 64.5469, sd: 21.2576 } },
            8: { PF: { mean: 50.5556, sd: 31.2728 }, RP: { mean: 50.9259, sd: 46.3180 }, BP: { mean: 52.3704, sd: 31.5291 }, GH: { mean: 41.9630, sd: 23.4376 }, VT: { mean: 46.1111, sd: 23.4655 }, SF: { mean: 62.2685, sd: 28.9855 }, RE: { mean: 54.9383, sd: 44.9353 }, MH: { mean: 57.9259, sd: 23.3722 } }
        },
        2: { // Sesso = 2 (Femmina)
            2: { PF: { mean: 96.8478, sd: 6.6182 }, RP: { mean: 85.3261, sd: 31.9151 }, BP: { mean: 82.5109, sd: 21.9452 }, GH: { mean: 75.4239, sd: 14.1446 }, VT: { mean: 64.2935, sd: 17.3614 }, SF: { mean: 77.8533, sd: 23.9550 }, RE: { mean: 74.2754, sd: 37.9908 }, MH: { mean: 68.6957, sd: 17.8552 } },
            3: { PF: { mean: 94.2172, sd: 13.6217 }, RP: { mean: 90.2778, sd: 23.8342 }, BP: { mean: 80.3182, sd: 24.5401 }, GH: { mean: 74.3990, sd: 16.4093 }, VT: { mean: 65.1263, sd: 17.5019 }, SF: { mean: 78.9141, sd: 19.2784 }, RE: { mean: 81.4815, sd: 31.9412 }, MH: { mean: 69.8990, sd: 18.3090 } },
            4: { PF: { mean: 90.4054, sd: 14.4641 }, RP: { mean: 81.4865, sd: 32.7388 }, BP: { mean: 74.4000, sd: 24.6885 }, GH: { mean: 69.2757, sd: 18.5749 }, VT: { mean: 61.3514, sd: 18.5129 }, SF: { mean: 76.7568, sd: 22.2378 }, RE: { mean: 77.1171, sd: 37.7361 }, MH: { mean: 63.4541, sd: 21.3136 } },
            5: { PF: { mean: 85.9074, sd: 16.8844 }, RP: { mean: 75.8287, sd: 35.9302 }, BP: { mean: 68.9560, sd: 27.1034 }, GH: { mean: 64.1099, sd: 18.9535 }, VT: { mean: 59.5185, sd: 19.2604 }, SF: { mean: 76.5797, sd: 21.6724 }, RE: { mean: 77.5641, sd: 36.1429 }, MH: { mean: 64.3778, sd: 20.2981 } },
            6: { PF: { mean: 75.2448, sd: 24.5972 }, RP: { mean: 72.8343, sd: 37.9604 }, BP: { mean: 63.2712, sd: 28.8583 }, GH: { mean: 58.2429, sd: 22.7831 }, VT: { mean: 54.5198, sd: 21.5975 }, SF: { mean: 74.5763, sd: 23.6082 }, RE: { mean: 67.7966, sd: 41.8780 }, MH: { mean: 57.8475, sd: 22.1273 } },
            7: { PF: { mean: 63.4487, sd: 27.8130 }, RP: { mean: 55.3846, sd: 43.0189 }, BP: { mean: 58.4231, sd: 30.9493 }, GH: { mean: 47.4846, sd: 24.6367 }, VT: { mean: 51.2949, sd: 23.0579 }, SF: { mean: 70.0000, sd: 27.9118 }, RE: { mean: 66.6667, sd: 41.2968 }, MH: { mean: 56.3385, sd: 23.9484 } },
            8: { PF: { mean: 42.5000, sd: 28.5273 }, RP: { mean: 42.0343, sd: 44.1061 }, BP: { mean: 45.0882, sd: 29.0284 }, GH: { mean: 38.8382, sd: 24.7390 }, VT: { mean: 40.6618, sd: 23.4187 }, SF: { mean: 55.5147, sd: 26.4842 }, RE: { mean: 49.0196, sd: 46.5993 }, MH: { mean: 48.5294, sd: 25.3351 } }
        }
    };

    function N() {	var num=0;	if (N.arguments.length==1 && Array.isArray(N.arguments[0])) { var arr=N.arguments[0];		for (var i=0;i<arr.length;i++) if (arr[i] !== null && !isNaN(arr[i])) num++;	} else { for (var i=0;i<N.arguments.length;i++)	if (N.arguments[i] !== null && !isNaN(N.arguments[i])) num++;	}	return(num);}
    function SUM() { var sum=0;	if (SUM.arguments.length==1 && Array.isArray(SUM.arguments[0])) { var arr=SUM.arguments[0]; for (var i=0;i<arr.length;i++) if (arr[i] !== null && !isNaN(arr[i])) sum+=arr[i];	} else { for (var i=0;i<SUM.arguments.length;i++) if (SUM.arguments[i] !== null && !isNaN(SUM.arguments[i])) sum+=SUM.arguments[i];	}	return(sum);}
    function MEAN() { var num=0; var sum=0; if (MEAN.arguments.length==1 && Array.isArray(MEAN.arguments[0])) { var arr=MEAN.arguments[0];	for (var i=0;i<arr.length;i++) if (arr[i] !== null && !isNaN(arr[i])) { num++; sum+=arr[i];	}	} else { for (var i=0;i<MEAN.arguments.length;i++) if (MEAN.arguments[i] !== null && !isNaN(MEAN.arguments[i])) { num++; sum+=MEAN.arguments[i];	}	} return(num === 0 ? NaN : sum/num); }


    function getRawValue(inputElement) {
        if (!inputElement) return { value: null, valid: false };
        const valueStr = inputElement.value;
        let valueNum = null;
        let isValid = false;
        inputElement.classList.remove('invalid-input');

        if (valueStr !== null && valueStr.trim() !== '') {
            valueNum = parseInt(valueStr, 10);
            if (!isNaN(valueNum)) {
                const min = inputElement.min ? parseInt(inputElement.min, 10) : null;
                const max = inputElement.max ? parseInt(inputElement.max, 10) : null;
                if ((min === null || valueNum >= min) && (max === null || valueNum <= max)) {
                    const index = inputElement.dataset.index;
                    if (index !== undefined && itemValidRanges[index]) {
                        const range = itemValidRanges[index];
                        if (valueNum >= range.min && valueNum <= range.max) {
                            isValid = true;
                        }
                    } else {
                         isValid = true;
                    }
                }
            }
        }
        if (!isValid && valueStr !== null && valueStr.trim() !== '') {
             inputElement.classList.add('invalid-input');
        } else if (valueStr === null || valueStr.trim() === '') {
            valueNum = NaN;
            isValid = false;
        }
        return { value: (valueStr !== null && valueStr.trim() !== '' && isValid) ? valueNum : NaN, valid: isValid };
    }


    function calculateAllSf36Scores(p, age, sex) {
        let results = { scores: {}, zScores: {}, summaries: {}, ageSexScores: {} };
        let i = 0;

        const getPVal = (originalKey) => {
            const keyMap = {
                "PF01": 2, "PF02": 3, "PF03": 4, "PF04": 5, "PF05": 6, "PF06": 7, "PF07": 8, "PF08": 9, "PF09": 10, "PF10": 11,
                "RP1": 12, "RP2": 13, "RP3": 14, "RP4": 15,
                "BP1": 20, "BP2": 21,
                "GH1": 0, "GH2": 32, "GH3": 33, "GH4": 34, "GH5": 35,
                "VT1": 22, "VT2": 26, "VT3": 28, "VT4": 30,
                "SF1": 19, "SF2": 31,
                "RE1": 16, "RE2": 17, "RE3": 18,
                "MH1": 23, "MH2": 24, "MH3": 25, "MH4": 27, "MH5": 29,
                "HT": 1
            };
            return p[keyMap[originalKey]];
        };

        let PFI = [
            getPVal("PF01"), getPVal("PF02"), getPVal("PF03"), getPVal("PF04"), getPVal("PF05"),
            getPVal("PF06"), getPVal("PF07"), getPVal("PF08"), getPVal("PF09"), getPVal("PF10")
        ];
        let PFNUM = N(PFI);
        let PFMEAN = MEAN(PFI);
        if (!isNaN(PFMEAN)) {
           for (i = 0; i < 10; i++) if (isNaN(PFI[i])) PFI[i] = PFMEAN;
        }
        let RAWPF = 0;
        if (PFNUM >= 5) RAWPF = SUM(PFI); else RAWPF = NaN;
        results.scores['PF'] = (PFNUM >= 5 && !isNaN(RAWPF)) ? ((RAWPF - 10) / (30 - 10)) * 100 : null;
        if (results.scores['PF'] !== null) results.scores['PF'] = Math.max(0, Math.min(100, results.scores['PF']));

        let RPA = [getPVal("RP1"), getPVal("RP2"), getPVal("RP3"), getPVal("RP4")];
        let ROLPNUM = N(RPA);
        let ROLPMEAN = MEAN(RPA);
        if(!isNaN(ROLPMEAN)) {
            for (i = 0; i < 4; i++) if (isNaN(RPA[i])) RPA[i] = ROLPMEAN;
        }
        let RAWRP = 0;
        if (ROLPNUM >= 2) RAWRP = SUM(RPA); else RAWRP = NaN;
        results.scores['RP'] = (ROLPNUM >= 2 && !isNaN(RAWRP)) ? ((RAWRP - 4) / (8 - 4)) * 100 : null;
        if (results.scores['RP'] !== null) results.scores['RP'] = Math.max(0, Math.min(100, results.scores['RP']));

        let BP1_raw = getPVal("BP1");
        let BP2_raw = getPVal("BP2");
        let RBP1 = NaN; let RBP2 = NaN;
        if (!isNaN(BP1_raw)) {
            if (BP1_raw==1) RBP1=6; else if (BP1_raw==2) RBP1=5.4; else if (BP1_raw==3) RBP1=4.2; else if (BP1_raw==4) RBP1=3.1; else if (BP1_raw==5) RBP1=2.2; else if (BP1_raw==6) RBP1=1;
        }
        if (!isNaN(BP2_raw)) {
            if (BP2_raw==1) RBP2=6; else if (BP2_raw==2) RBP2=4.75; else if (BP2_raw==3) RBP2=3.5; else if (BP2_raw==4) RBP2=2.25; else if (BP2_raw==5) RBP2=1;
        }
        if (!isNaN(BP1_raw) && !isNaN(BP2_raw)) {
            if (BP2_raw==1 && BP1_raw==1) RBP2=6;
            else if (BP2_raw==1 && BP1_raw>=2 && BP1_raw<=6) RBP2=5;
            else if (BP2_raw==2 && BP1_raw>=1 && BP1_raw<=6) RBP2=4;
            else if (BP2_raw==3 && BP1_raw>=1 && BP1_raw<=6) RBP2=3;
            else if (BP2_raw==4 && BP1_raw>=1 && BP1_raw<=6) RBP2=2;
            else if (BP2_raw==5 && BP1_raw>=1 && BP1_raw<=6) RBP2=1;
        } else if (!isNaN(BP1_raw) && isNaN(BP2_raw)) {
            RBP2 = RBP1;
        } else if (isNaN(BP1_raw) && !isNaN(BP2_raw)) {
            RBP1 = RBP2;
        }
        let BPNUM = N(BP1_raw, BP2_raw);
        let RAWBP = NaN;
        if (BPNUM >= 1) RAWBP = SUM(RBP1, RBP2);
        results.scores['BP'] = (BPNUM >= 1 && !isNaN(RAWBP)) ? ((RAWBP - 2) / (12 - 2)) * 100 : null;
        if (results.scores['BP'] !== null) results.scores['BP'] = Math.max(0, Math.min(100, results.scores['BP']));

        let GH1_raw = getPVal("GH1"); let GH2_raw = getPVal("GH2"); let GH3_raw = getPVal("GH3"); let GH4_raw = getPVal("GH4"); let GH5_raw = getPVal("GH5");
        let RGH_Items_For_Mean = [];
        let RGH1_rec = NaN;
        if (!isNaN(GH1_raw)) { if (GH1_raw==1) RGH1_rec=5; else if (GH1_raw==2) RGH1_rec=4.4; else if (GH1_raw==3) RGH1_rec=3.4; else if (GH1_raw==4) RGH1_rec=2; else if (GH1_raw==5) RGH1_rec=1; }
        RGH_Items_For_Mean.push(RGH1_rec);
        RGH_Items_For_Mean.push(GH2_raw);
        let RGH3_rec = NaN; if(!isNaN(GH3_raw)) RGH3_rec = 6 - GH3_raw;
        RGH_Items_For_Mean.push(RGH3_rec);
        RGH_Items_For_Mean.push(GH4_raw);
        let RGH5_rec = NaN; if(!isNaN(GH5_raw)) RGH5_rec = 6 - GH5_raw;
        RGH_Items_For_Mean.push(RGH5_rec);
        let GHNUM_raw = N(GH1_raw, GH2_raw, GH3_raw, GH4_raw, GH5_raw);
        let GHMEAN = MEAN(RGH_Items_For_Mean);
        let RGH_final = [RGH1_rec, GH2_raw, RGH3_rec, GH4_raw, RGH5_rec];
         if (!isNaN(GHMEAN)) {
            for (i = 0; i < 5; i++) if (isNaN(RGH_final[i])) RGH_final[i] = GHMEAN;
        }
        let RAWGH = NaN;
        if (GHNUM_raw >= 3) RAWGH = SUM(RGH_final);
        results.scores['GH'] = (GHNUM_raw >=3 && !isNaN(RAWGH)) ? ((RAWGH - 5) / (25 - 5)) * 100 : null;
        if (results.scores['GH'] !== null) results.scores['GH'] = Math.max(0, Math.min(100, results.scores['GH']));

        let VT1_raw_val = getPVal("VT1"); let VT2_raw_val = getPVal("VT2"); let VT3_raw_val = getPVal("VT3"); let VT4_raw_val = getPVal("VT4");
        let RVI_Items_For_Mean_calc = [];
        let RVT1_rec = NaN; if(!isNaN(VT1_raw_val)) RVT1_rec = 7 - VT1_raw_val;
        RVI_Items_For_Mean_calc.push(RVT1_rec);
        let RVT2_rec = NaN; if(!isNaN(VT2_raw_val)) RVT2_rec = 7 - VT2_raw_val;
        RVI_Items_For_Mean_calc.push(RVT2_rec);
        RVI_Items_For_Mean_calc.push(VT3_raw_val);
        RVI_Items_For_Mean_calc.push(VT4_raw_val);
        let VITNUM_raw_count = N(VT1_raw_val, VT2_raw_val, VT3_raw_val, VT4_raw_val);
        let VITMEAN_val = MEAN(RVI_Items_For_Mean_calc);
        let RVI_final = [RVT1_rec, RVT2_rec, VT3_raw_val, VT4_raw_val];
        if(!isNaN(VITMEAN_val)) {
            for (i = 0; i < 4; i++) if (isNaN(RVI_final[i])) RVI_final[i] = VITMEAN_val;
        }
        let RAWVT_val = NaN;
        if (VITNUM_raw_count >= 2) RAWVT_val = SUM(RVI_final);
        results.scores['VT'] = (VITNUM_raw_count >= 2 && !isNaN(RAWVT_val)) ? ((RAWVT_val - 4) / (24 - 4)) * 100 : null;
        if (results.scores['VT'] !== null) results.scores['VT'] = Math.max(0, Math.min(100, results.scores['VT']));

        let SF1_raw_val = getPVal("SF1"); let SF2_raw_val = getPVal("SF2");
        let RSF_Items_For_Mean_calc = [];
        let RSF1_rec = NaN; if(!isNaN(SF1_raw_val)) RSF1_rec = 6 - SF1_raw_val;
        RSF_Items_For_Mean_calc.push(RSF1_rec);
        RSF_Items_For_Mean_calc.push(SF2_raw_val);
        let SFNUM_raw_count = N(SF1_raw_val, SF2_raw_val);
        let SFMEAN_val = MEAN(RSF_Items_For_Mean_calc);
        let RSF_final = [RSF1_rec, SF2_raw_val];
        if(!isNaN(SFMEAN_val)) {
            for (i = 0; i < 2; i++) if (isNaN(RSF_final[i])) RSF_final[i] = SFMEAN_val;
        }
        let RAWSF_val = NaN;
        if (SFNUM_raw_count >= 1) RAWSF_val = SUM(RSF_final);
        results.scores['SF'] = (SFNUM_raw_count >= 1 && !isNaN(RAWSF_val)) ? ((RAWSF_val - 2) / (10 - 2)) * 100 : null;
        if (results.scores['SF'] !== null) results.scores['SF'] = Math.max(0, Math.min(100, results.scores['SF']));

        let RM_raw_vals = [getPVal("RE1"), getPVal("RE2"), getPVal("RE3")];
        let ROLMNUM_count = N(RM_raw_vals);
        let ROLMMEAN_val = MEAN(RM_raw_vals);
        let RM_final = [...RM_raw_vals];
        if(!isNaN(ROLMMEAN_val)) {
            for (i = 0; i < 3; i++) if (isNaN(RM_final[i])) RM_final[i] = ROLMMEAN_val;
        }
        let RAWRE_val = NaN;
        if (ROLMNUM_count >= 2) RAWRE_val = SUM(RM_final);
        results.scores['RE'] = (ROLMNUM_count >= 2 && !isNaN(RAWRE_val)) ? ((RAWRE_val - 3) / (6 - 3)) * 100 : null;
        if (results.scores['RE'] !== null) results.scores['RE'] = Math.max(0, Math.min(100, results.scores['RE']));

        let MH1_raw_val = getPVal("MH1"); let MH2_raw_val = getPVal("MH2"); let MH3_raw_val = getPVal("MH3"); let MH4_raw_val = getPVal("MH4"); let MH5_raw_val = getPVal("MH5");
        let RMH_Items_For_Mean_calc = [];
        RMH_Items_For_Mean_calc.push(MH1_raw_val);
        RMH_Items_For_Mean_calc.push(MH2_raw_val);
        let RMH3_rec = NaN; if(!isNaN(MH3_raw_val)) RMH3_rec = 7 - MH3_raw_val;
        RMH_Items_For_Mean_calc.push(RMH3_rec);
        RMH_Items_For_Mean_calc.push(MH4_raw_val);
        let RMH5_rec = NaN; if(!isNaN(MH5_raw_val)) RMH5_rec = 7 - MH5_raw_val;
        RMH_Items_For_Mean_calc.push(RMH5_rec);
        let MHNUM_raw_count = N(MH1_raw_val, MH2_raw_val, MH3_raw_val, MH4_raw_val, MH5_raw_val);
        let MHMEAN_val = MEAN(RMH_Items_For_Mean_calc);
        let RMH_final = [MH1_raw_val, MH2_raw_val, RMH3_rec, MH4_raw_val, RMH5_rec];
        if (!isNaN(MHMEAN_val)) {
            for (i = 0; i < 5; i++) if (isNaN(RMH_final[i])) RMH_final[i] = MHMEAN_val;
        }
        let RAWMH_val = NaN;
        if (MHNUM_raw_count >= 3) RAWMH_val = SUM(RMH_final);
        results.scores['MH'] = (MHNUM_raw_count >=3 && !isNaN(RAWMH_val)) ? ((RAWMH_val - 5) / (30 - 5)) * 100 : null;
        if (results.scores['MH'] !== null) results.scores['MH'] = Math.max(0, Math.min(100, results.scores['MH']));

        const htRaw_val = getPVal("HT");
        results.scores['HT'] = (htRaw_val !== null && !isNaN(htRaw_val) && htRaw_val >= 1 && htRaw_val <= 5) ? ({ 1: 100, 2: 75, 3: 50, 4: 25, 5: 0 })[htRaw_val] : null;

        let allScoresValidForSummaries = true;
        for (const scale in usMeans) {
            const score = results.scores[scale];
            if (score === null || isNaN(score)) { // Check for null specifically for summary calculations
                results.zScores[scale] = null;
                allScoresValidForSummaries = false;
            } else {
                 results.zScores[scale] = (score - usMeans[scale]) / usSDs[scale];
            }
        }

        results.summaries['PCS'] = null;
        results.summaries['MCS'] = null;
        if (allScoresValidForSummaries) {
            let pcsWeightedSum = 0;
            let mcsWeightedSum = 0;
            for (const scale in weights.PCS) {
                 if (results.zScores[scale] !== null) {
                    pcsWeightedSum += results.zScores[scale] * weights.PCS[scale];
                    mcsWeightedSum += results.zScores[scale] * weights.MCS[scale];
                 } else { // If any Z-score is null, cannot calculate summaries
                    allScoresValidForSummaries = false; // Redundant but safe
                    break;
                 }
            }
            if(allScoresValidForSummaries) { // Re-check after loop, in case a zScore was null
                results.summaries['PCS'] = (pcsWeightedSum * 10) + 50;
                results.summaries['MCS'] = (mcsWeightedSum * 10) + 50;
            }
        }

        const ageNum = parseInt(age);
        const sexNum = parseInt(sex);
        let classeEta = 0;
        let canCalculateAgeSexScores = false;

        if (!isNaN(ageNum) && ageNum > 0) {
            if (ageNum <= 24) classeEta = 2;
            else if (ageNum <= 34) classeEta = 3;
            else if (ageNum <= 44) classeEta = 4;
            else if (ageNum <= 54) classeEta = 5;
            else if (ageNum <= 64) classeEta = 6;
            else if (ageNum <= 74) classeEta = 7;
            else classeEta = 8;
        }

        if ((sexNum === 1 || sexNum === 2) && classeEta >= 2 && classeEta <= 8) {
             canCalculateAgeSexScores = true;
         }

        const scalesForAgeSex = ['PF', 'RP', 'BP', 'GH', 'VT', 'SF', 'RE', 'MH'];
        scalesForAgeSex.forEach(scale => {
            results.ageSexScores[scale] = null;
            if (canCalculateAgeSexScores) {
                const score0100 = results.scores[scale];
                if (score0100 !== null && !isNaN(score0100) && ageSexNorms[sexNum] && ageSexNorms[sexNum][classeEta] && ageSexNorms[sexNum][classeEta][scale]) {
                    const norms = ageSexNorms[sexNum][classeEta][scale];
                    const mean = norms.mean;
                    const sd = norms.sd;
                    if (sd !== null && sd !== undefined && sd !== 0) {
                        results.ageSexScores[scale] = (((score0100 - mean) / sd) * 10) + 50;
                    }
                }
            }
        });
        demographicData.age = !isNaN(ageNum) ? ageNum : null;
        demographicData.sex = (sexNum === 1 || sexNum === 2) ? sexNum : null;
        demographicData.ageClass = classeEta;
        demographicData.canCalculateAgeSex = canCalculateAgeSexScores;

        return results;
    }

    function tooltipCallback(context) {
        let label = context.dataset.label || '';
        if (label) {
            label += ': ';
        }
        const value = context.parsed.y;
        const originalScore = context.dataset.originalScores ? context.dataset.originalScores[context.dataIndex] : null;

        if (originalScore !== null && originalScore !== 'N/D' && originalScore !== 'N/A' && !isNaN(originalScore)) {
            label += originalScore.toFixed(1);
        } else if (originalScore === 'N/A') {
             label += 'N/A';
        }
         else {
            label += 'N/D';
        }
        return label;
    }

    function initScoresChart() {
        const ctx = document.getElementById('scoresChart').getContext('2d');
        const chartLabels = ['PF', 'RP', 'BP', 'GH', 'VT', 'SF', 'RE', 'MH', 'HT'];
        const chartDisplayLabels = ['Att. Fisica', 'R. Fisico', 'Dolore', 'Salute Gen.', 'Vitalità', 'Funz. Sociale', 'R. Emotivo', 'Salute Mentale', 'Trans. Salute'];
        const backgroundColors = ['#1abc9c', '#e74c3c', '#f1c40f', '#3498db', '#9b59b6', '#e67e22', '#95a5a6', '#2ecc71', '#34495e'];

        scoresChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartDisplayLabels,
                datasets: [{
                    label: 'Punteggio Scala (0-100)',
                    data: Array(chartLabels.length).fill(0),
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors,
                    borderWidth: 1,
                    originalScores: Array(chartLabels.length).fill('N/D'),
                    scaleKeys: chartLabels
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Punteggio (0 = Peggiore, 100 = Migliore)' } }, x: {} },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: tooltipCallback } } }
            }
        });
    }

    function initSummaryChart() {
         const ctx = document.getElementById('summaryChart').getContext('2d');
         const chartLabels = ['PCS', 'MCS'];
         const chartDisplayLabels = ['Indice Salute Fisica (ISF/PCS)', 'Indice Salute Mentale (ISM/MCS)'];
         const backgroundColors = ['#3498db', '#2ecc71'];

         summaryChartInstance = new Chart(ctx, {
             type: 'bar',
             data: {
                 labels: chartDisplayLabels,
                 datasets: [{
                     label: 'Punteggio T (USA)',
                     data: [0, 0],
                     backgroundColor: backgroundColors,
                     borderColor: backgroundColors,
                     borderWidth: 1,
                     originalScores: ['N/D', 'N/D'],
                     scaleKeys: chartLabels
                 }]
             },
             options: {
                 responsive: true, maintainAspectRatio: false, indexAxis: 'x',
                 scales: {
                     y: { beginAtZero: false, min: 0, max: 100, title: { display: true, text: 'Punteggio T (Media 50, DS 10)' } },
                     x: {}
                 },
                 plugins: {
                     legend: { display: false },
                     tooltip: { callbacks: { label: tooltipCallback } },
                     annotation: {
                         annotations: {
                             line1: { type: 'line', yMin: 50, yMax: 50, borderColor: 'grey', borderWidth: 2, borderDash: [6, 6], label: { content: 'Media Pop. USA', display: true, position: 'start', font: {size: 10} } }
                         }
                     }
                 }
             }
         });
     }

    function updateDisplay(elementId, value, naClass = 'na-score', digits = 1) {
        const element = document.getElementById(elementId);
        if (!element) return;

        if (value !== null && value !== undefined && !isNaN(value)) {
            element.textContent = value.toFixed(digits);
            element.classList.remove(naClass);
        } else {
            element.textContent = 'N/D';
            element.classList.add(naClass);
        }
    }

    function updateChartData(chartInstance, dataObject) {
        if (!chartInstance || !dataObject) return;
        const dataset = chartInstance.data.datasets[0];
        dataset.scaleKeys.forEach((key, index) => {
            if (index < dataset.data.length && index < dataset.originalScores.length) {
                const value = dataObject[key];
                if (value !== null && value !== undefined && !isNaN(value)) {
                    dataset.data[index] = value;
                    dataset.originalScores[index] = value;
                } else {
                    if (dataObject.hasOwnProperty(key)){
                        dataset.data[index] = 0;
                        dataset.originalScores[index] = 'N/D';
                    } else {
                         dataset.data[index] = 0;
                         dataset.originalScores[index] = 'N/A';
                    }
                }
            }
        });
        chartInstance.update();
    }

    function updateScoresAndChart() {
        allAnswers = new Array(36).fill(NaN);
        document.querySelectorAll('.score-input').forEach(input => {
            const index = parseInt(input.getAttribute('data-index'));
            const { value } = getRawValue(input);
            allAnswers[index] = value;
        });

        const ageInput = document.getElementById('eta');
        const sexInput = document.getElementById('sesso');
        const { value: ageValue } = getRawValue(ageInput);
        const sexStrValue = sexInput ? sexInput.value : "";
        const sexNumValue = (sexStrValue === "1" || sexStrValue === "2") ? parseInt(sexStrValue) : NaN;

        const results = calculateAllSf36Scores(allAnswers, ageValue, sexNumValue);

        Object.keys(results.scores).forEach(scale => updateDisplay(`score_${scale.toLowerCase()}`, results.scores[scale], 'na-score'));
        Object.keys(results.zScores).forEach(scale => updateDisplay(`zscore_${scale.toLowerCase()}`, results.zScores[scale], 'na-score', 2));
        Object.keys(results.summaries).forEach(summary => updateDisplay(`summary_${summary.toLowerCase()}`, results.summaries[summary], 'na-score'));
        Object.keys(results.ageSexScores).forEach(scale => updateDisplay(`agesex_${scale.toLowerCase()}`, results.ageSexScores[scale], 'na-score'));

        const ageSexSection = document.getElementById('age-sex-scores-section');
        const ageSexChartSection = document.getElementById('age-sex-chart-section'); // This ID is no longer in HTML
        const ageSexWarning = document.getElementById('age-sex-warning');


        if (demographicData.canCalculateAgeSex) {
            ageSexSection.classList.remove('hidden-section');
            // ageSexChartSection.classList.remove('hidden-section'); // RIMOSSO
            ageSexWarning.classList.add('hidden-section');
        } else {
            ageSexSection.classList.add('hidden-section');
            // ageSexChartSection.classList.add('hidden-section'); // RIMOSSO
            ageSexWarning.classList.remove('hidden-section');
            Object.keys(results.ageSexScores).forEach(scale => updateDisplay(`agesex_${scale.toLowerCase()}`, null, 'na-score'));
        }

        updateChartData(scoresChartInstance, results.scores);
        updateChartData(summaryChartInstance, results.summaries);
        // updateChartData(zScoreChartInstance, results.zScores); // RIMOSSO
        // updateChartData(ageSexTScoreChartInstance, results.ageSexScores); // RIMOSSO
    }

    document.addEventListener('DOMContentLoaded', () => {
        initScoresChart();
        initSummaryChart();
        // initZScoreChart(); // RIMOSSO
        // initAgeSexTScoreChart(); // RIMOSSO
        document.querySelectorAll('.score-input, .demographic-input').forEach(input => {
            input.addEventListener('input', updateScoresAndChart);
            input.addEventListener('blur', updateScoresAndChart);
        });
        updateScoresAndChart();
    });

</script>

</body>
</html>
