<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Punteggio SF-36 con Grafico</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; vertical-align: top;}
        th { background-color: #e9e9e9; font-weight: bold; }
        td:first-child { font-weight: bold; width: 80px; } /* ID Domanda */
        .input-col { width: 100px; text-align: center;}
        input[type="number"] { /* Rimosso input[type="text"] */
             width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
             box-sizing: border-box; /* Include padding in width */
             text-align: center;
        }
        input:invalid { border-color: red; } /* Stile per input non validi (HTML5) */
        .invalid-input { border-color: red !important; background-color: #fff7f7; } /* Stile JS per input fuori range */
        .question-text { width: 65%; }
        .scale-info { font-size: 0.9em; color: #555; }
        #scores, #chart-container { margin-top: 30px; padding: 15px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 5px;}
        .score-table td { font-weight: bold; }
        .score-display { min-width: 70px; display: inline-block; text-align: right; padding: 5px; background-color: #f0f0f0; border-radius: 3px; font-family: monospace;}
        .na-score { color: #888; } /* Stile per N/A */
        .notes { font-size: 0.9em; color: #666; margin-top: 15px; }
        #chart-container { /* Contenitore per il grafico */
             position: relative;
             height: 40vh; /* Altezza del grafico */
             width: 90%;  /* Larghezza del grafico */
             max-width: 800px; /* Larghezza massima */
             margin-left: auto;
             margin-right: auto;
             margin-bottom: 30px;
        }
        #visitor-counter { /* Stile per il contenitore del contatore */
            margin: 20px 0;
            padding: 5px; /* Ridotto padding se il widget ha il suo */
            /* Rimuovo stili specifici del contenitore precedente se il widget li gestisce */
            /* background-color: #eef; */
            /* border: 1px solid #cce; */
            /* border-radius: 4px; */
            text-align: center; /* Mantiene il widget centrato se necessario */
        }
        /* Potrebbe essere necessario aggiungere stili specifici per .elfsight-app-... se vuoi personalizzare ulteriormente */
    </style>
</head>
<body>

<h1>Calcolatore Punteggio SF-36</h1>
<p>Inserisci i valori per ciascuna domanda nelle caselle sottostanti. I punteggi delle 8 dimensioni SF-36 verranno calcolati e visualizzati automaticamente nella tabella e nel grafico a barre.</p>

<div id="visitor-counter">
    <script src="https://static.elfsight.com/platform/platform.js" data-use-service-core defer></script> 
    <div class="elfsight-app-3a6a3cc6-59bc-4c0a-af91-4bef6b171bd3" data-elfsight-app-lazy></div>
    
</div>


<form id="sf36-form" onsubmit="return false;"> <table>
        <thead>
            <tr>
                <th>ID Domanda</th>
                <th class="question-text">Testo Domanda (Indicativo)</th>
                <th class="input-col">Risposta</th>
                <th class="scale-info">Scala Valori / Note</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Q1</td>
                <td>In generale, diresti che la tua salute è:</td>
                <td class="input-col"><input type="number" id="q1" class="score-input" min="1" max="5" step="1" required></td>
                <td class="scale-info">1=Eccellente, 2=Molto buona, 3=Buona, 4=Discreta, 5=Scadente<br><i>(Algoritmo usa 1-5 per GH)</i></td>
            </tr>
             <tr>
                <td>Q2 (HT)</td>
                <td>Rispetto a un anno fa, come giudicheresti la tua salute attuale?</td>
                <td class="input-col"><input type="number" id="q2" class="score-input" min="1" max="5" step="1" required></td>
                <td class="scale-info">1=Molto migliore, ..., 5=Molto peggiore<br><i>(Item Health Transition (HT), non usato nei punteggi 0-100)</i></td>
            </tr>
            <tr><td colspan="4" style="background-color: #f8f8f8;"><b>La tua salute attuale ti limita nello svolgere queste attività? Se sì, quanto?</b></td></tr>
            <tr><td>Q3a</td><td>Attività pesanti</td><td class="input-col"><input type="number" id="q3a" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1=Sì, molto limitato<br>2=Sì, poco limitato<br>3=No, per niente limitato</td></tr>
            <tr><td>Q3b</td><td>Attività moderate</td><td class="input-col"><input type="number" id="q3b" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3c</td><td>Sollevare/trasportare borse spesa</td><td class="input-col"><input type="number" id="q3c" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3d</td><td>Salire qualche rampa di scale</td><td class="input-col"><input type="number" id="q3d" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3e</td><td>Salire una rampa di scale</td><td class="input-col"><input type="number" id="q3e" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3f</td><td>Piegarsi, inginocchiarsi</td><td class="input-col"><input type="number" id="q3f" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3g</td><td>Camminare per > 1 km</td><td class="input-col"><input type="number" id="q3g" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3h</td><td>Camminare per diverse centinaia m</td><td class="input-col"><input type="number" id="q3h" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3i</td><td>Camminare per 100 m</td><td class="input-col"><input type="number" id="q3i" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td>Q3j</td><td>Fare il bagno o vestirsi</td><td class="input-col"><input type="number" id="q3j" class="score-input" min="1" max="3" step="1" required></td><td class="scale-info">1-3</td></tr>
            <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Ultime 4 sett., problemi nel lavoro/attività A CAUSA DELLA SALUTE FISICA?</b></td></tr>
            <tr><td>Q4a</td><td>Ridotto tempo dedicato?</td><td class="input-col"><input type="number" id="q4a" class="score-input" min="1" max="2" step="1" required></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q4b</td><td>Ottenuto meno del voluto?</td><td class="input-col"><input type="number" id="q4b" class="score-input" min="1" max="2" step="1" required></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q4c</td><td>Limitato nel tipo di attività?</td><td class="input-col"><input type="number" id="q4c" class="score-input" min="1" max="2" step="1" required></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q4d</td><td>Avuto difficoltà (sforzo extra)?</td><td class="input-col"><input type="number" id="q4d" class="score-input" min="1" max="2" step="1" required></td><td class="scale-info">1=Sì, 2=No</td></tr>
             <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Ultime 4 sett., problemi nel lavoro/attività A CAUSA DI PROBLEMI EMOTIVI?</b></td></tr>
            <tr><td>Q5a</td><td>Ridotto tempo dedicato?</td><td class="input-col"><input type="number" id="q5a" class="score-input" min="1" max="2" step="1" required></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q5b</td><td>Ottenuto meno del voluto?</td><td class="input-col"><input type="number" id="q5b" class="score-input" min="1" max="2" step="1" required></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr><td>Q5c</td><td>Svolto attività meno attentamente?</td><td class="input-col"><input type="number" id="q5c" class="score-input" min="1" max="2" step="1" required></td><td class="scale-info">1=Sì, 2=No</td></tr>
            <tr>
                <td>Q6</td>
                <td>Ultime 4 sett., quanto salute fisica/emotiva ha interferito con normali attività sociali?</td>
                <td class="input-col"><input type="number" id="q6" class="score-input" min="1" max="5" step="1" required></td>
                <td class="scale-info">1=Per niente, ..., 5=Moltissimo<br><i>(Algoritmo usa 1-5 per SF)</i></td>
            </tr>
            <tr>
                <td>Q7</td>
                <td>Quanto dolore fisico provato ultime 4 sett.?</td>
                <td class="input-col"><input type="number" id="q7" class="score-input" min="1" max="6" step="1" required></td>
                <td class="scale-info">1=Nessuno, ..., 6=Fortissimo<br><i>(Algoritmo recodifica 1->6 ... 6->1)</i></td>
            </tr>
            <tr>
                <td>Q8</td>
                <td>Ultime 4 sett., quanto il dolore ha interferito con lavoro normale?</td>
                <td class="input-col"><input type="number" id="q8" class="score-input" min="1" max="5" step="1" required></td>
                <td class="scale-info">1=Per niente, ..., 5=Moltissimo<br><i>(Algoritmo recodifica 1->5 ... 5->1)</i></td>
            </tr>
             <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Ultime 4 sett., come ti sei sentito?</b></td></tr>
            <tr><td>Q9a (VT)</td><td>Sentito pieno di energia?</td><td class="input-col"><input type="number" id="q9a" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo usa 1-6 per VT)</i></td></tr>
            <tr><td>Q9b (MH)</td><td>Stato nervoso?</td><td class="input-col"><input type="number" id="q9b" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo recodifica 1->6 ... 6->1)</i></td></tr>
            <tr><td>Q9c (MH)</td><td>Sentito così giù che niente poteva rallegrarti?</td><td class="input-col"><input type="number" id="q9c" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo recodifica 1->6 ... 6->1)</i></td></tr>
            <tr><td>Q9d (MH)</td><td>Sentito calmo e sereno?</td><td class="input-col"><input type="number" id="q9d" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo usa 1-6 per MH)</i></td></tr>
            <tr><td>Q9e (VT)</td><td>Avuto molta energia?</td><td class="input-col"><input type="number" id="q9e" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo usa 1-6 per VT)</i></td></tr>
            <tr><td>Q9f (MH)</td><td>Sentito demoralizzato e triste?</td><td class="input-col"><input type="number" id="q9f" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo recodifica 1->6 ... 6->1)</i></td></tr>
            <tr><td>Q9g (VT)</td><td>Sentito esausto?</td><td class="input-col"><input type="number" id="q9g" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo recodifica 1->6 ... 6->1)</i></td></tr>
            <tr><td>Q9h (MH)</td><td>Stato felice?</td><td class="input-col"><input type="number" id="q9h" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo usa 1-6 per MH)</i></td></tr>
            <tr><td>Q9i (VT)</td><td>Sentito stanco?</td><td class="input-col"><input type="number" id="q9i" class="score-input" min="1" max="6" step="1" required></td><td class="scale-info">1=Sempre, ..., 6=Mai<br><i>(Algoritmo recodifica 1->6 ... 6->1)</i></td></tr>
            <tr>
                <td>Q10</td>
                <td>Ultime 4 sett., quanto spesso salute fisica/emotiva ha interferito con attività sociali?</td>
                <td class="input-col"><input type="number" id="q10" class="score-input" min="1" max="5" step="1" required></td>
                 <td class="scale-info">1=Sempre, ..., 5=Mai<br><i>(Algoritmo usa 1-5 per SF)</i></td>
            </tr>
             <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Quanto è vero o falso per te?</b></td></tr>
            <tr><td>Q11a</td><td>Mi ammalo più facilmente degli altri</td><td class="input-col"><input type="number" id="q11a" class="score-input" min="1" max="5" step="1" required></td><td class="scale-info">1=Assolutamente vero, ..., 5=Assolutamente falso<br><i>(Algoritmo recodifica 1->5 ... 5->1)</i></td></tr>
            <tr><td>Q11b</td><td>Sono sano come chiunque altro</td><td class="input-col"><input type="number" id="q11b" class="score-input" min="1" max="5" step="1" required></td><td class="scale-info">1=Assolutamente vero, ..., 5=Assolutamente falso<br><i>(Algoritmo usa 1-5 per GH)</i></td></tr>
            <tr><td>Q11c</td><td>Mi aspetto che la mia salute peggiori</td><td class="input-col"><input type="number" id="q11c" class="score-input" min="1" max="5" step="1" required></td><td class="scale-info">1=Assolutamente vero, ..., 5=Assolutamente falso<br><i>(Algoritmo recodifica 1->5 ... 5->1)</i></td></tr>
            <tr><td>Q11d</td><td>La mia salute è eccellente</td><td class="input-col"><input type="number" id="q11d" class="score-input" min="1" max="5" step="1" required></td><td class="scale-info">1=Assolutamente vero, ..., 5=Assolutamente falso<br><i>(Algoritmo usa 1-5 per GH)</i></td></tr>
        </tbody>
    </table>
</form>

<div id="scores">
    <h2>Punteggi Calcolati (Scala 0-100)</h2>
    <p class="notes">I punteggi vengono aggiornati automaticamente. Un punteggio più alto indica uno stato di salute migliore.</p>
    <table class="score-table">
        <thead>
            <tr>
                <th>Dimensione SF-36</th>
                <th>Punteggio (0-100)</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Physical Functioning (PF) <br><small>(Funzionamento Fisico)</small></td><td><span id="score_pf" class="score-display na-score">N/A</span></td></tr>
            <tr><td>Role Physical (RP) <br><small>(Limitazioni Ruolo Fisico)</small></td><td><span id="score_rp" class="score-display na-score">N/A</span></td></tr>
            <tr><td>Bodily Pain (BP) <br><small>(Dolore Fisico)</small></td><td><span id="score_bp" class="score-display na-score">N/A</span></td></tr>
            <tr><td>General Health (GH) <br><small>(Salute Generale)</small></td><td><span id="score_gh" class="score-display na-score">N/A</span></td></tr>
            <tr><td>Vitality (VT) <br><small>(Vitalità)</small></td><td><span id="score_vt" class="score-display na-score">N/A</span></td></tr>
            <tr><td>Social Functioning (SF) <br><small>(Funzionamento Sociale)</small></td><td><span id="score_sf" class="score-display na-score">N/A</span></td></tr>
            <tr><td>Role Emotional (RE) <br><small>(Limitazioni Ruolo Emotivo)</small></td><td><span id="score_re" class="score-display na-score">N/A</span></td></tr>
            <tr><td>Mental Health (MH) <br><small>(Salute Mentale)</small></td><td><span id="score_mh" class="score-display na-score">N/A</span></td></tr>
        </tbody>
    </table>
     <p class="notes"><i>Nota: I punteggi sono calcolati secondo l'algoritmo standard SF-36 (RAND). '<span class="na-score">N/A</span>' indica che mancano input validi o sono fuori scala per calcolare il punteggio di quella dimensione. Assicurati che tutti i campi numerici richiesti siano compilati correttamente.</i></p>
</div>

<div id="chart-container">
    <h2>Grafico Riepilogativo Punteggi</h2>
    <canvas id="scoresChart"></canvas> </div>


<script>
    // --- Variabile Globale per il Grafico ---
    let scoresChartInstance = null;

    // --- Funzioni di Recodifica ---
    function recodeYesNo(value) {
        const numValue = parseInt(value);
        if (numValue === 1) return 0;
        if (numValue === 2) return 1;
        return NaN;
    }
    function recodeQ7(value) {
        const numValue = parseInt(value);
        const map = { 1: 6, 2: 5, 3: 4, 4: 3, 5: 2, 6: 1 };
        return map[numValue];
    }
    function recodeQ8(value) {
        const numValue = parseInt(value);
        const map = { 1: 5, 2: 4, 3: 3, 4: 2, 5: 1 };
        return map[numValue];
    }
    function recode6ptReverse(value) {
        const numValue = parseInt(value);
        const map = { 1: 6, 2: 5, 3: 4, 4: 3, 5: 2, 6: 1 };
        return map[numValue];
    }
     function recode5ptReverse(value) {
        const numValue = parseInt(value);
        const map = { 1: 5, 2: 4, 3: 3, 4: 2, 5: 1 };
        return map[numValue];
    }

    // --- Helper Functions ---
    function getInputValue(id) {
        const el = document.getElementById(id);
        if (!el || (el.type === 'number' && el.value === '')) { // Controlla solo i campi numerici per vuoto
             if(el) el.classList.add('invalid-input');
            return NaN;
        }
        if (el.type === 'number') {
            const value = parseFloat(el.value);
            const min = el.min !== "" ? parseFloat(el.min) : -Infinity;
            const max = el.max !== "" ? parseFloat(el.max) : Infinity;

            if (isNaN(value) || value < min || value > max || (el.step === "1" && !Number.isInteger(value))) {
                el.classList.add('invalid-input');
                return NaN;
            } else {
                el.classList.remove('invalid-input');
                return value;
            }
        }
         // Non ci sono altri tipi di input qui, ma per sicurezza:
        return NaN; // Ritorna NaN per tipi non gestiti
    }

    function checkValues(...values) {
        return values.every(v => !isNaN(v) && v !== undefined);
    }
    function transformScore(rawScore, minScore, maxScore) {
        if (isNaN(rawScore)) return NaN;
        const range = maxScore - minScore;
        if (range === 0) return (rawScore >= minScore) ? 100 : 0;
        const score = 100 * (rawScore - minScore) / range;
        const clampedScore = Math.max(0, Math.min(100, score));
        return parseFloat(clampedScore.toFixed(2));
    }

    // --- Funzioni di Calcolo per Dimensione (Invariate) ---
    function calculatePF() {
        const items = ['q3a', 'q3b', 'q3c', 'q3d', 'q3e', 'q3f', 'q3g', 'q3h', 'q3i', 'q3j'];
        const values = items.map(getInputValue);
        if (!checkValues(...values)) return { raw: NaN, score: NaN };
        const rawScore = values.reduce((sum, v) => sum + v, 0);
        return { raw: rawScore, score: transformScore(rawScore, 10, 30) };
    }
    function calculateRP() {
        const items = ['q4a', 'q4b', 'q4c', 'q4d'];
        const values = items.map(id => recodeYesNo(getInputValue(id)));
        if (!checkValues(...values)) return { raw: NaN, score: NaN };
        const rawScore = values.reduce((sum, v) => sum + v, 0);
        return { raw: rawScore, score: transformScore(rawScore, 0, 4) };
    }
    function calculateBP() {
        const valQ7 = recodeQ7(getInputValue('q7'));
        const valQ8 = recodeQ8(getInputValue('q8'));
        if (!checkValues(valQ7, valQ8)) return { raw: NaN, score: NaN };
        const rawScore = valQ7 + valQ8;
        return { raw: rawScore, score: transformScore(rawScore, 2, 11) };
    }
     function calculateGH() {
        const valQ1 = getInputValue('q1');
        const valQ11a = recode5ptReverse(getInputValue('q11a'));
        const valQ11b = getInputValue('q11b');
        const valQ11c = recode5ptReverse(getInputValue('q11c'));
        const valQ11d = getInputValue('q11d');
        if (!checkValues(valQ1, valQ11a, valQ11b, valQ11c, valQ11d)) return { raw: NaN, score: NaN };
        const rawScore = valQ1 + valQ11a + valQ11b + valQ11c + valQ11d;
        return { raw: rawScore, score: transformScore(rawScore, 5, 25) };
    }
     function calculateVT() {
        const valQ9a = getInputValue('q9a');
        const valQ9e = getInputValue('q9e');
        const valQ9g = recode6ptReverse(getInputValue('q9g'));
        const valQ9i = recode6ptReverse(getInputValue('q9i'));
        if (!checkValues(valQ9a, valQ9e, valQ9g, valQ9i)) return { raw: NaN, score: NaN };
        const rawScore = valQ9a + valQ9e + valQ9g + valQ9i;
        return { raw: rawScore, score: transformScore(rawScore, 4, 24) };
    }
    function calculateSF() {
        const valQ6 = getInputValue('q6');
        const valQ10 = getInputValue('q10');
         if (!checkValues(valQ6, valQ10)) return { raw: NaN, score: NaN };
        const rawScore = valQ6 + valQ10;
        return { raw: rawScore, score: transformScore(rawScore, 2, 10) };
    }
     function calculateRE() {
        const items = ['q5a', 'q5b', 'q5c'];
        const values = items.map(id => recodeYesNo(getInputValue(id)));
        if (!checkValues(...values)) return { raw: NaN, score: NaN };
        const rawScore = values.reduce((sum, v) => sum + v, 0);
        return { raw: rawScore, score: transformScore(rawScore, 0, 3) };
    }
     function calculateMH() {
        const valQ9b = recode6ptReverse(getInputValue('q9b'));
        const valQ9c = recode6ptReverse(getInputValue('q9c'));
        const valQ9d = getInputValue('q9d');
        const valQ9f = recode6ptReverse(getInputValue('q9f'));
        const valQ9h = getInputValue('q9h');
        if (!checkValues(valQ9b, valQ9c, valQ9d, valQ9f, valQ9h)) return { raw: NaN, score: NaN };
        const rawScore = valQ9b + valQ9c + valQ9d + valQ9f + valQ9h;
        return { raw: rawScore, score: transformScore(rawScore, 5, 30) };
    }

    // --- Inizializzazione Grafico (Invariata) ---
    function initChart() {
        const ctx = document.getElementById('scoresChart').getContext('2d');
        const chartLabels = ['PF', 'RP', 'BP', 'GH', 'VT', 'SF', 'RE', 'MH'];
        const backgroundColors = ['#4BC0C0', '#FF6384', '#FFCE56', '#36A2EB', '#9966FF', '#FF9F40', '#C9CBCF', '#4D5360'];
        const borderColors = backgroundColors; // Bordi dello stesso colore delle barre

        scoresChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Punteggi SF-36 (0-100)',
                    data: [0, 0, 0, 0, 0, 0, 0, 0],
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Punteggio (0-100)' }},
                          x: { title: { display: true, text: 'Dimensioni SF-36' }} },
                plugins: { legend: { display: false },
                           tooltip: { callbacks: { label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                // Mostra N/A se il valore originale era NaN, altrimenti mostra il numero
                                const originalScore = context.chart.data.datasets[context.datasetIndex].originalScores[context.dataIndex];
                                if (originalScore === 'N/A') {
                                   label += 'N/A';
                                } else if (context.parsed.y !== null) {
                                   label += context.parsed.y.toFixed(2);
                                }
                                return label;
                           }}}}
            }
        });
    }

    // --- Funzione Principale & Aggiornamento UI ---
    function calculateScores() {
        const results = {
            pf: calculatePF(), rp: calculateRP(), bp: calculateBP(), gh: calculateGH(),
            vt: calculateVT(), sf: calculateSF(), re: calculateRE(), mh: calculateMH()
        };

        // Aggiorna tabella
        const scoreValuesForTable = {};
        for (const [key, value] of Object.entries(results)) {
            const scoreElement = document.getElementById(`score_${key}`);
            const displayValue = isNaN(value.score) ? 'N/A' : value.score.toFixed(2);
            scoreValuesForTable[key] = displayValue; // Salva valore per tooltip grafico
            if (scoreElement) {
                scoreElement.textContent = displayValue;
                if (displayValue === 'N/A') { scoreElement.classList.add('na-score'); }
                else { scoreElement.classList.remove('na-score'); }
            }
        }

        // Aggiorna grafico
        if (scoresChartInstance) {
            // Prepara dati per il grafico (0 per N/A) e dati originali per tooltip
            const chartData = [];
            const originalScoresForTooltip = [];
            const keys = ['pf', 'rp', 'bp', 'gh', 'vt', 'sf', 're', 'mh'];
            keys.forEach(key => {
                const score = results[key].score;
                const displayValue = scoreValuesForTable[key]; // Prendi dalla tabella (include 'N/A')
                chartData.push(isNaN(score) ? 0 : score); // Usa 0 per barre N/A
                originalScoresForTooltip.push(displayValue); // Usa 'N/A' o numero per tooltip
            });

            scoresChartInstance.data.datasets[0].data = chartData;
            // Aggiungo un campo custom al dataset per accedere ai valori originali nel tooltip
            scoresChartInstance.data.datasets[0].originalScores = originalScoresForTooltip;
            scoresChartInstance.update();
        }
    }

    // --- Event Listener ---
    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        const inputs = document.querySelectorAll('.score-input');
        inputs.forEach(input => {
            input.addEventListener('input', calculateScores);
            input.addEventListener('blur', (e) => getInputValue(e.target.id)); // Ri-valida on blur
        });
        calculateScores(); // Calcolo iniziale
    });

</script>

</body>
</html>
