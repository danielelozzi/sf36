<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Punteggio SF-36</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; vertical-align: top;}
        th { background-color: #e9e9e9; font-weight: bold; }
        td:first-child { font-weight: bold; width: 80px; } /* ID Domanda */
        .input-col { width: 100px; text-align: center;}
        input[type="number"] {
             width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
             box-sizing: border-box;
             text-align: center;
        }
        input:invalid { border-color: red; }
        .invalid-input { border-color: red !important; background-color: #fff7f7; }
        .question-text { width: 65%; }
        .scale-info { font-size: 0.9em; color: #555; }
        #scores, #chart-container { margin-top: 30px; padding: 15px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 5px;}
        .score-table td { font-weight: bold; }
        .score-display { min-width: 70px; display: inline-block; text-align: right; padding: 5px; background-color: #f0f0f0; border-radius: 3px; font-family: monospace;}
        .na-score { color: #888; }
        .notes { font-size: 0.9em; color: #666; margin-top: 15px; }
        #chart-container {
             position: relative; height: 40vh; width: 90%; max-width: 800px;
             margin-left: auto; margin-right: auto; margin-bottom: 30px;
        }
        /* Stile per evidenziare input non valido */
        input.invalid-input {
            border-color: red;
            background-color: #ffecec;
        }
    </style>
</head>
<body>

<h1>Calcolatore Punteggio SF-36 (Basato su PDF - Corretto)</h1>
<p>Inserisci i valori per ciascuna domanda nelle caselle sottostanti. I punteggi delle 8 dimensioni SF-36 (secondo le regole del PDF) verranno calcolati e visualizzati.</p>
<p class="notes" style="color:red; font-weight:bold;">Ver2</p>

<form id="sf36-form" onsubmit="return false;">
    <table>
        <thead>
            <tr>
                <th>ID Domanda</th>
                <th class="question-text">Testo Domanda (da PDF originale / codice)</th>
                <th class="input-col">Risposta</th>
                <th class="scale-info">Scala Valori / Note PDF Item #</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Q1</td>
                <td class="question-text">In generale direbbe che la Sua salute è....</td>
                <td class="input-col"><input type="number" id="q1" data-index="0" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 / PDF Item #1</td>
            </tr>
             <tr>
                <td>Q2 (HT)</td>
                <td class="question-text">Rispetto a un anno fa, come giudicherebbe, ora, la Sua salute in generale?</td>
                <td class="input-col"><input type="number" id="q2" data-index="1" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 / PDF Item #2</td>
            </tr>
            <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Le seguenti domande riguardano alcune attività che potrebbe svolgere nel corso di una qualsiasi giornata...</b></td></tr>
                <tr><td>Q3a</td><td>Attività fisicamente impegnative...</td><td class="input-col"><input type="number" id="q3a" data-index="2" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #3</td></tr>
            <tr><td>Q3b</td><td>Attività di moderato impegno fisico...</td><td class="input-col"><input type="number" id="q3b" data-index="3" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #4</td></tr>
            <tr><td>Q3c</td><td>Sollevare o portare le borse della spesa</td><td class="input-col"><input type="number" id="q3c" data-index="4" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #5</td></tr>
            <tr><td>Q3d</td><td>Salire qualche piano di scale</td><td class="input-col"><input type="number" id="q3d" data-index="5" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #6</td></tr>
            <tr><td>Q3e</td><td>Salire un piano di scale</td><td class="input-col"><input type="number" id="q3e" data-index="6" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #7</td></tr>
            <tr><td>Q3f</td><td>Piegarsi, inginocchiarsi o chinarsi</td><td class="input-col"><input type="number" id="q3f" data-index="7" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #8</td></tr>
            <tr><td>Q3g</td><td>Camminare per un chilometro</td><td class="input-col"><input type="number" id="q3g" data-index="8" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #9</td></tr>
            <tr><td>Q3h</td><td>Camminare per qualche centinaia di metri</td><td class="input-col"><input type="number" id="q3h" data-index="9" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #10</td></tr>
            <tr><td>Q3i</td><td>Camminare per circa cento metri</td><td class="input-col"><input type="number" id="q3i" data-index="10" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #11</td></tr>
            <tr><td>Q3j</td><td>Fare il bagno o vestirsi da soli</td><td class="input-col"><input type="number" id="q3j" data-index="11" class="score-input" min="1" max="3" step="1"></td><td class="scale-info">1-3 / PDF Item #12</td></tr>
            <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Nelle ultime quattro settimane, ha riscontrato i seguenti problemi sul lavoro o nelle altre attività quotidiane, a causa della Sua salute fisica?</b></td></tr>
            <tr><td>Q4a</td><td>Ha ridotto il tempo dedicato al lavoro o ad altre attività</td><td class="input-col"><input type="number" id="q4a" data-index="12" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No / PDF Item #13</td></tr>
            <tr><td>Q4b</td><td>Ha reso meno di quanto avrebbe voluto</td><td class="input-col"><input type="number" id="q4b" data-index="13" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No / PDF Item #14</td></tr>
            <tr><td>Q4c</td><td>Ha dovuto limitare alcuni tipi di lavoro o di altre attività</td><td class="input-col"><input type="number" id="q4c" data-index="14" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No / PDF Item #15</td></tr>
            <tr><td>Q4d</td><td>Ha avuto difficoltà nell'eseguire il lavoro o altre attività...</td><td class="input-col"><input type="number" id="q4d" data-index="15" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No / PDF Item #16</td></tr>
            <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Nelle ultime quattro settimane, ha riscontrato i seguenti problemi sul lavoro o nelle altre attività quotidiane, a causa del Suo stato emotivo...?</b></td></tr>
             <tr><td>Q5a</td><td>Ha ridotto il tempo dedicato al lavoro o ad altre attività</td><td class="input-col"><input type="number" id="q5a" data-index="16" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No / PDF Item #17</td></tr>
            <tr><td>Q5b</td><td>Ha reso meno di quanto avrebbe voluto</td><td class="input-col"><input type="number" id="q5b" data-index="17" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No / PDF Item #18</td></tr>
            <tr><td>Q5c</td><td>Ha avuto un calo di concentrazione sul lavoro o in altre attività</td><td class="input-col"><input type="number" id="q5c" data-index="18" class="score-input" min="1" max="2" step="1"></td><td class="scale-info">1=Sì, 2=No / PDF Item #19</td></tr>
             <tr>
                <td>Q6</td>
                <td class="question-text">Nelle ultime quattro settimane, in che misura la Sua salute fisica o il Suo stato emotivo hanno interferito con le normali attività sociali...</td>
                <td class="input-col"><input type="number" id="q6" data-index="19" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 / PDF Item #20</td>
            </tr>
             <tr>
                <td>Q7</td>
                <td class="question-text">Quanto dolore fisico ha provato nelle ultime quattro settimane?</td>
                <td class="input-col"><input type="number" id="q7" data-index="20" class="score-input" min="1" max="6" step="1"></td>
                <td class="scale-info">1-6 / PDF Item #21</td>
            </tr>
            <tr>
                <td>Q8</td>
                <td class="question-text">Nelle ultime quattro settimane, in che misura il dolore L'ha ostacolata nel lavoro che svolge abitualmente...?</td>
                <td class="input-col"><input type="number" id="q8" data-index="21" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 / PDF Item #22</td>
            </tr>
            <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Le seguenti domande si riferiscono a come si è sentito nelle ultime quattro settimane...</b></td></tr>
             <tr><td>Q9a (VT)</td><td>Vivace e brillante?</td><td class="input-col"><input type="number" id="q9a" data-index="22" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #23</td></tr>
            <tr><td>Q9b (MH)</td><td>Molto agitato?</td><td class="input-col"><input type="number" id="q9b" data-index="23" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #24</td></tr>
            <tr><td>Q9c (MH)</td><td>Così giù di morale che niente avrebbe potuto tirarla su?</td><td class="input-col"><input type="number" id="q9c" data-index="24" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #25</td></tr>
            <tr><td>Q9d (MH)</td><td>Calmo e sereno?</td><td class="input-col"><input type="number" id="q9d" data-index="25" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #26</td></tr>
            <tr><td>Q9e (VT)</td><td>Pieno di energia?</td><td class="input-col"><input type="number" id="q9e" data-index="26" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #27</td></tr>
            <tr><td>Q9f (MH)</td><td>Scoraggiato e triste?</td><td class="input-col"><input type="number" id="q9f" data-index="27" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #28</td></tr>
            <tr><td>Q9g (VT)</td><td>Sfinito?</td><td class="input-col"><input type="number" id="q9g" data-index="28" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #29</td></tr>
            <tr><td>Q9h (MH)</td><td>Felice?</td><td class="input-col"><input type="number" id="q9h" data-index="29" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #30</td></tr>
            <tr><td>Q9i (VT)</td><td>Stanco?</td><td class="input-col"><input type="number" id="q9i" data-index="30" class="score-input" min="1" max="6" step="1"></td><td class="scale-info">1-6 / PDF Item #31</td></tr>
            <tr>
                <td>Q10 (SF)</td>
                <td class="question-text">Nelle ultime quattro settimane, per quanto tempo la Sua salute fisica o il Suo stato emotivo hanno interferito nelle Sue attività sociali...?</td>
                <td class="input-col"><input type="number" id="q10" data-index="31" class="score-input" min="1" max="5" step="1"></td>
                <td class="scale-info">1-5 / PDF Item #32</td>
            </tr>
             <tr><td colspan="4" style="background-color: #f8f8f8;"><b>Scelga, per ogni domanda, la risposta che meglio descrive quanto siano Vere o False le seguenti affermazioni.</b></td></tr>
             <tr><td>Q11a</td><td>Mi pare di ammalarmi un po' più facilmente degli altri</td><td class="input-col"><input type="number" id="q11a" data-index="32" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5 / PDF Item #33</td></tr>
            <tr><td>Q11b</td><td>La mia salute è come quella degli altri</td><td class="input-col"><input type="number" id="q11b" data-index="33" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5 / PDF Item #34</td></tr>
            <tr><td>Q11c</td><td>Mi aspetto che la mia salute andrà peggiorando</td><td class="input-col"><input type="number" id="q11c" data-index="34" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5 / PDF Item #35</td></tr>
            <tr><td>Q11d</td><td>Godo di ottima salute</td><td class="input-col"><input type="number" id="q11d" data-index="35" class="score-input" min="1" max="5" step="1"></td><td class="scale-info">1-5 / PDF Item #36</td></tr>
        </tbody>
    </table>
</form>

<div id="scores">
    <h2>Punteggi Calcolati (Scala 0-100, secondo PDF)</h2>
    <p class="notes">I punteggi vengono aggiornati automaticamente. Un punteggio più alto indica uno stato di salute migliore. 'N/D' indica che mancano troppe risposte per calcolare il punteggio di quella dimensione (max 50% mancanti).</p>
    <table class="score-table">
        <thead>
            <tr>
                <th>Dimensione SF-36 (Nomi da PDF)</th>
                <th>Punteggio (0-100)</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Funzionamento fisico (PF)</td><td><span id="score_pf" class="score-display na-score">N/D</span></td></tr>
            <tr><td>Limitazioni di ruolo dovute alla salute fisica (RP)</td><td><span id="score_rp" class="score-display na-score">N/D</span></td></tr>
            <tr><td>Limitazioni di ruolo dovute a problemi emotivi (RE)</td><td><span id="score_re" class="score-display na-score">N/D</span></td></tr>
            <tr><td>Energia/fatica (VT)</td><td><span id="score_vt" class="score-display na-score">N/D</span></td></tr>
            <tr><td>Benessere emotivo (MH)</td><td><span id="score_mh" class="score-display na-score">N/D</span></td></tr>
            <tr><td>Funzionamento sociale (SF)</td><td><span id="score_sf" class="score-display na-score">N/D</span></td></tr>
            <tr><td>Dolore (BP)</td><td><span id="score_bp" class="score-display na-score">N/D</span></td></tr>
            <tr><td>Salute generale (GH)</td><td><span id="score_gh" class="score-display na-score">N/D</span></td></tr>
            <tr><td>Health Transition (HT) <br><small>(Non nel sommario PDF, calcolato separatamente)</small></td><td><span id="score_ht" class="score-display na-score">N/D</span></td></tr>
        </tbody>
    </table>
     <p class="notes"><i>Nota: I punteggi sono calcolati secondo la logica specificata nel PDF (ricodifica item 0-100, media dimensione basata sul N totale di item, gestione missing 50%). Assicurati che tutti i campi numerici richiesti siano compilati correttamente con valori interi nei range indicati.</i></p>
</div>

<div id="chart-container">
    <h2>Grafico Riepilogativo Punteggi (Secondo PDF)</h2>
    <canvas id="scoresChart"></canvas>
</div>


<script>
    // --- Variabile Globale per il Grafico ---
    let scoresChartInstance = null;
    let allAnswers = new Array(36).fill(null); // Array per memorizzare tutte le risposte

    // --- Mappe di Ricodifica BASATE SUL PDF ---
    const RECODE_PDF_G1 = {1: 100, 2: 75, 3: 50, 4: 25, 5: 0};       // Per PDF Items: 1, 2, 20, 22, 34, 36 -> Indices: 0, 1, 19, 21, 33, 35
    const RECODE_PDF_G2 = {1: 0, 2: 50, 3: 100};                    // Per PDF Items: 3-12 -> Indices: 2-11
    const RECODE_PDF_G3 = {1: 0, 2: 100};                           // Per PDF Items: 13-19 -> Indices: 12-18
    const RECODE_PDF_G4 = {1: 100, 2: 80, 3: 60, 4: 40, 5: 20, 6: 0};// Per PDF Items: 21, 23, 26, 27, 30 -> Indices: 20, 22, 25, 26, 29
    const RECODE_PDF_G5 = {1: 0, 2: 20, 3: 40, 4: 60, 5: 80, 6: 100};// Per PDF Items: 24, 25, 28, 29, 31 -> Indices: 23, 24, 27, 28, 30
    const RECODE_PDF_G6 = {1: 0, 2: 25, 3: 50, 4: 75, 5: 100};       // Per PDF Items: 32, 33, 35 -> Indices: 31, 32, 34

    // --- Mappatura Indici (0-based) -> Item e Scale BASATA SUL PDF ---
    const scaleIndices = {
        'PF': [...Array(10).keys()].map(i => i + 2),  // Indici 2-11 (PDF Items 3-12)
        'RP': [...Array(4).keys()].map(i => i + 12),  // Indici 12-15 (PDF Items 13-16)
        'RE': [...Array(3).keys()].map(i => i + 16),  // Indici 16-18 (PDF Items 17-19)
        'VT': [22, 26, 28, 30],                       // Indici per PDF Items 23, 27, 29, 31 ('Energia/fatica')
        'MH': [23, 24, 25, 27, 29],                       // Indici per PDF Items 24, 25, 26, 28, 30 ('Benessere emotivo')
        'SF': [19, 31],                               // Indici per PDF Items 20, 32 ('Funzionamento sociale')
        'BP': [20, 21],                               // Indici per PDF Items 21, 22 ('Dolore') - Corretto
        'GH': [0, 32, 33, 34, 35],                       // Indici per PDF Items 1, 33, 34, 35, 36 ('Salute generale') - Corretto
        'HT': [1]                                     // Indice 1 (PDF Item 2) - Trattato separatamente
    };

     // --- Dizionario delle Mappe di Ricodifica per Indice BASATO SUL PDF ---
    // Ricostruito per chiarezza e sicurezza
    const itemRecodeMap = {};
    // Gruppo 1: Indices 0, 1, 19, 21, 33, 35
    [0, 1, 19, 21, 33, 35].forEach(i => itemRecodeMap[i] = RECODE_PDF_G1);
    // Gruppo 2: Indices 2-11
    [...Array(10).keys()].map(i => i + 2).forEach(i => itemRecodeMap[i] = RECODE_PDF_G2);
    // Gruppo 3: Indices 12-18
    [...Array(7).keys()].map(i => i + 12).forEach(i => itemRecodeMap[i] = RECODE_PDF_G3);
     // Gruppo 4: Indices 20, 22, 25, 26, 29
    [20, 22, 25, 26, 29].forEach(i => itemRecodeMap[i] = RECODE_PDF_G4);
    // Gruppo 5: Indices 23, 24, 27, 28, 30
    [23, 24, 27, 28, 30].forEach(i => itemRecodeMap[i] = RECODE_PDF_G5);
    // Gruppo 6: Indices 31, 32, 34
    [31, 32, 34].forEach(i => itemRecodeMap[i] = RECODE_PDF_G6);


    // --- Helper Functions (invariate) ---
    function getInputValue(inputElement) {
        if (!inputElement) return { value: null, valid: false };

        const valueStr = inputElement.value.trim();
        if (valueStr === '') {
            inputElement.classList.remove('invalid-input');
            return { value: null, valid: true }; // Missing è valido in sé
        }

        const value = parseInt(valueStr);
        const min = inputElement.min !== "" ? parseInt(inputElement.min) : -Infinity;
        const max = inputElement.max !== "" ? parseInt(inputElement.max) : Infinity;
        const index = parseInt(inputElement.getAttribute('data-index'));
        const recodeMapForThisItem = itemRecodeMap[index];

        if (isNaN(value) || !Number.isInteger(value) || value < min || value > max || !recodeMapForThisItem || !recodeMapForThisItem.hasOwnProperty(value)) {
            inputElement.classList.add('invalid-input');
            return { value: null, valid: false };
        } else {
            inputElement.classList.remove('invalid-input');
            return { value: value, valid: true };
        }
    }

    // --- Funzione di Calcolo Generale (CORRETTA) ---
    function calculateSf36Scores(answers) {
        let results = {};

        for (const [scale, indices] of Object.entries(scaleIndices)) {
            if (scale === 'HT') continue;

            let validRawAnswers = [];
            let numItems = indices.length; // Numero totale di item nel dominio

            for (const idx of indices) {
                const ans = answers[idx];
                const recodeMapForItem = itemRecodeMap[idx];
                if (ans !== null && typeof ans === 'number' && recodeMapForItem && recodeMapForItem.hasOwnProperty(ans)) {
                    validRawAnswers.push(ans);
                } else {
                    validRawAnswers.push(null); // Tratta non valido/mancante come null
                }
            }

            const missingCount = validRawAnswers.filter(ans => ans === null).length;

            if (missingCount > numItems / 2) {
                results[scale] = null; // Troppi missing
                continue;
            }

            let recodedScores = [];
            let sum = 0;
            let validItemCount = 0; // Contatore item validi effettivamente ricodificati
            for (let i = 0; i < numItems; i++) {
                const rawAnswer = validRawAnswers[i];
                 if (rawAnswer !== null) {
                    const itemIndex = indices[i];
                    const recodeFunc = itemRecodeMap[itemIndex];
                    const recodedValue = recodeFunc[rawAnswer];
                    recodedScores.push(recodedValue); // Teniamo traccia per debug se necessario
                    sum += recodedValue;
                    validItemCount++;
                 }
                 // Gli item mancanti (rawAnswer === null) non contribuiscono alla somma
            }

            // CORREZIONE: Applica la formula del PDF dividendo per il numero totale di item nel dominio
            if (validItemCount === 0 && missingCount > 0) { // Se tutti gli item sono mancanti (ma <= 50%)
                 results[scale] = null; // Non possiamo calcolare nulla
            } else if (numItems > 0) { // Assicurati che il dominio abbia item
                 results[scale] = sum / numItems; // Dividi la somma per il numero TOTALE di item del dominio
            } else {
                 results[scale] = null; // Dominio senza item? (Improbabile ma sicuro)
            }
        }

        // Calcolo Health Transition (HT) separatamente
        const htIndex = scaleIndices['HT'][0];
        const htRaw = answers[htIndex];
        const recodeMapHt = itemRecodeMap[htIndex];
        if (htRaw === null || typeof htRaw !== 'number' || !recodeMapHt || !recodeMapHt.hasOwnProperty(htRaw)) {
            results['HT'] = null;
        } else {
            results['HT'] = recodeMapHt[htRaw];
        }

        // Arrotondamento finale per visualizzazione (opzionale, fatto durante display)
        // for (const scale in results) {
        //     if (results[scale] !== null) {
        //         results[scale] = Math.round(results[scale] * 100) / 100; // Arrotonda a 2 decimali
        //     }
        // }

        return results;
    }


    // --- Inizializzazione Grafico (invariato) ---
    function initChart() {
        const ctx = document.getElementById('scoresChart').getContext('2d');
        const chartLabels = ['PF', 'RP', 'RE', 'VT', 'MH', 'SF', 'BP', 'GH', 'HT'];
        const chartDisplayLabels = [
            'Fisico (PF)', 'Lim. Ruolo Fisico (RP)', 'Lim. Ruolo Emotivo (RE)',
            'Energia (VT)', 'Benessere Emo. (MH)', 'Sociale (SF)',
            'Dolore (BP)', 'Salute Gen. (GH)', 'Transizione Salute (HT)'
        ];
        const backgroundColors = ['#4BC0C0', '#FF6384', '#FFCE56', '#36A2EB', '#9966FF', '#FF9F40', '#C9CBCF', '#4D5360', '#AABBCC'];
        const borderColors = backgroundColors;

        scoresChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartDisplayLabels,
                datasets: [{
                    label: 'Punteggi SF-36 (0-100, PDF)',
                    data: Array(chartLabels.length).fill(0),
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    originalScores: Array(chartLabels.length).fill('N/D'),
                    scaleKeys: chartLabels
                }]
            },
            options: { /* opzioni invariate */
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'x',
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Punteggio (0-100)' }},
                    x: { title: { display: true, text: 'Dimensioni SF-36 (secondo PDF)' }}
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                const originalScore = context.chart.data.datasets[context.datasetIndex].originalScores[context.dataIndex];
                                label += originalScore;
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- Funzione Principale & Aggiornamento UI (invariato) ---
    function updateScoresAndChart() {
        let formIsValid = true;
        allAnswers = [];
        const inputs = document.querySelectorAll('.score-input');
        inputs.forEach(input => {
            const index = parseInt(input.getAttribute('data-index'));
            const { value, valid } = getInputValue(input);
             allAnswers[index] = value;
             // Segna form non valido solo se c'è un input *compilato* ma non valido
             if (!valid && input.value.trim() !== '') {
                 formIsValid = false;
             }
        });

        const results = calculateSf36Scores(allAnswers);

        const scoreValuesForChart = {};
        const originalScoresForTooltip = {};
        for (const [key, score] of Object.entries(results)) {
            const scoreElement = document.getElementById(`score_${key.toLowerCase()}`);
            const displayValue = (score === null || isNaN(score)) ? 'N/D' : score.toFixed(2); // Arrotonda a 2 decimali qui
            scoreValuesForChart[key] = (score === null || isNaN(score)) ? 0 : score;
            originalScoresForTooltip[key] = displayValue;

            if (scoreElement) {
                scoreElement.textContent = displayValue;
                if (displayValue === 'N/D') { scoreElement.classList.add('na-score'); }
                else { scoreElement.classList.remove('na-score'); }
            } else {
                 console.warn(`Elemento score non trovato per la chiave: ${key.toLowerCase()}`);
            }
        }

        if (scoresChartInstance) {
            const chartData = [];
            const tooltipData = [];
            const chartKeys = scoresChartInstance.data.datasets[0].scaleKeys;
             chartKeys.forEach(key => {
                chartData.push(scoreValuesForChart[key] !== undefined ? scoreValuesForChart[key] : 0);
                tooltipData.push(originalScoresForTooltip[key] !== undefined ? originalScoresForTooltip[key] : 'N/D');
            });

            scoresChartInstance.data.datasets[0].data = chartData;
            scoresChartInstance.data.datasets[0].originalScores = tooltipData;
            scoresChartInstance.update();
        }
    }

    // --- Event Listener (invariati) ---
    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        const inputs = document.querySelectorAll('.score-input');
        inputs.forEach(input => {
            if (!input.hasAttribute('data-index')) {
                console.warn("Input senza data-index:", input.id);
            }
            input.addEventListener('input', updateScoresAndChart);
            input.addEventListener('blur', updateScoresAndChart);
        });
        updateScoresAndChart(); // Calcola all'inizio
    });

</script>

</body>
</html>
